# Architecture View — Executive

## Role & Responsibilities
- Function as a lightweight operating system for HSX: coordinating tasks, providing services, and abstracting hardware while running in native host code for performance.
- Implemented on host-side to take advantage of native hardware speeds.
- Coordinate MiniVM tasks: scheduling, attach/detach, run control.
- Provide IPC services (mailboxes), stdio routing, and HAL bindings.
- Expose RPC interface to shell/debugger clients.
- Manage provisioning of HSX apps and FRAM persistence.
- Offer value/command access layer so tasks can be observed/controlled externally.

## High-Level Structure
```
        Shell / Debugger / Automation
              |  JSON RPC / CLI
              v
+-----------------------------------+
|          HSX Executive           |
|  - Session manager (attach/detach)
|  - Scheduler (round-robin, waits)
|  - IPC services (mailbox manager)
|  - Value/command registry         |
|  - Provisioning / persistence     |
+----------------+------------------+
                 |
                 | VM control (step, context swap)
                 v
         +---------------------+
         |      MiniVM         |
         +---------------------+
                 |
                 | HAL services
        +--------+--------+
        |  UART / CAN /   |
        |  FRAM / FS / IO |
        +-----------------+
```
- Executive sits between host tooling and MiniVM, orchestrating task scheduling, IPC, and lifecycle.
- HAL drivers provide hardware access; executive abstracts them for HSX tasks.

## Interfaces
- **Control plane:** JSON-over-TCP RPC protocol (`docs/executive_protocol.md`) exposing commands like `ping`, `info`, `load`, `attach`, `clock`, `step`, `ps`, `sched`, `trace`, `mailbox` ops, `val`/`cmd` access.
- **Event stream:** Long-lived subscription delivering step events, debug stops, mailbox activity, value changes; feeds shell/debugger.
- **SVC bridge:** Handles SVC traps from MiniVM (mailboxes, values, provisioning, FS) and routes them to HAL or host services.
- **Provisioning hooks:** Load `.hxe` images from host path, CAN, SD; manage FRAM-backed persistence.
- **HAL integration:** UART/CAN/FRAM/FS drivers (native C on MCU, shims in Python prototype) invoked by executive.

## Relationships
- Owns MiniVM instance(s) and selects active task per time slice.
- Relies on toolchain outputs (.hxe) for task images.
- Serves shell, debugger, provisioning clients via network or local transport.
- Coordinates with value/command layer (`(3.4)val_cmd.md`) to expose telemetry/control endpoints.
- Works hand in hand with the scheduler issue remediation (`issues/#2_scheduler`) to enforce the single-instruction contract.

## Notes
- PID-scoped sessions ensure exclusive control per debugger.
- Event fan-out model underpins debugger and telemetry tooling.
- Designed for Python implementation first, with roadmap to native C port on embedded targets.
- Current Python implementation still uses snapshot-based context switches; architectural intent is to reuse register/stack arenas and swap contexts without copying (see `issues/#2_scheduler`).
- The architecture supports standalone operation (MiniVM without executive) but assumes the executive will take over when present, halting VM’s internal loop and driving execution via `step()`.
