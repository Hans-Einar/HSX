# Architecture View — Executive

## Role & Responsibilities
- Function as a lightweight operating system for HSX: coordinating tasks, providing services, and abstracting hardware while running in native host code for performance.
- Implemented on host-side to take advantage of native hardware speeds.
- Coordinate MiniVM tasks: scheduling, attach/detach, run control.
- **Preprocess HXE metadata (v2):** Parse `.value`, `.cmd`, `.mailbox` sections from HXE header and register all resources with app's PID before VM execution, eliminating VM initialization overhead.
- Provide IPC services (mailboxes), stdio routing, and HAL bindings.
- Expose RPC interface to shell/debugger clients.
- Manage provisioning of HSX apps and FRAM persistence.
- Offer value/command access layer so tasks can be observed/controlled externally.

## High-Level Structure
```
        Shell / Debugger / Automation
              |  JSON RPC / CLI
              v
+-----------------------------------+
|          HSX Executive           |
|  - Session manager (attach/detach)
|  - Scheduler (round-robin, waits)
|  - IPC services (mailbox manager)
|  - Value/command registry         |
|  - Provisioning / persistence     |
+----------------+------------------+
                 |
                 | VM control (step, context swap)
                 v
         +---------------------+
         |      MiniVM         |
         +---------------------+
                 |
                 | HAL services
        +--------+--------+
        |  UART / CAN /   |
        |  FRAM / FS / IO |
        +-----------------+
```
- Executive sits between host tooling and MiniVM, orchestrating task scheduling, IPC, and lifecycle.
- HAL drivers provide hardware access; executive abstracts them for HSX tasks.

## Interfaces
- **Control plane:** JSON-over-TCP RPC protocol ([docs/executive_protocol.md](../../docs/executive_protocol.md)) exposing commands like `ping`, `info`, `load`, `attach`, `clock`, `step`, `ps`, `sched`, `trace`, `mailbox` ops, `val`/`cmd` access.
- **Event stream:** Long-lived subscription delivering step events, debug stops, mailbox activity, value changes; feeds shell/debugger.
  - Sessions may operate in **owner** mode (PID lock) or **observer** mode (no PID lock). Observers share the event bus and receive read-only telemetry; owners retain control priority and cannot be blocked by observers thanks to per-session cursors and eviction rules documented in [docs/executive_protocol.md](../../docs/executive_protocol.md).
- **SVC bridge:** Handles SVC traps from MiniVM (mailboxes, values, provisioning, FS) and routes them to HAL or host services. Executive control traps (e.g., `sleep_ms`) live on module `0x06`. Context switching happens automatically when tasks block on mailbox operations or sleep—apps don't need explicit yield syscalls.
- **Provisioning hooks:** Load `.hxe` images from host path, CAN, SD; manage FRAM-backed persistence. see [03.06--Provisioning.md](03.06--Provisioning.md)

- **HAL integration:** UART/CAN/FRAM/FS drivers (native C on MCU, shims in Python prototype) invoked by executive.
- **Debugger API:** `session.open`, `events.subscribe`, and related RPCs provide a structured event channel for the debugger. Events include monotonically increasing sequence numbers, timestamps, PID, type, and payload fields (`pc`, `opcode`, `mailbox`, etc.), matching the contract in [docs/executive_protocol.md](../../docs/executive_protocol.md) and the debugger playbook ([functionality/#1_TUI_DEBUGGER](../../functionality/#1_TUI_DEBUGGER/)).

## Relationships
- Owns MiniVM instance(s) and selects active task per time slice.
- Relies on toolchain outputs (.hxe) for task images. With HXE format v2, toolchain generates declarative metadata sections from preprocessor directives (`#pragma hsx_value`, `#pragma hsx_command`, `#pragma hsx_mailbox`) that executive processes during load.
- Serves shell, debugger, provisioning clients via network or local transport.
- Coordinates with value/command layer ([03.04--ValCmd.md](03.04--ValCmd.md)) to expose telemetry/control endpoints. Values/commands defined in HXE metadata sections are registered in executive-owned storage before VM starts.
- Works hand in hand with the scheduler issue remediation ([issues/#2_scheduler](../../issues/#2_scheduler/01--Issue.md)) to enforce the single-instruction contract.

## Notes
- PID-scoped sessions ensure exclusive control per debugger.
- Event fan-out model underpins debugger and telemetry tooling.
- Designed for Python implementation first, with roadmap to native C port on embedded targets.
- Current Python implementation still uses snapshot-based context switches; architectural intent is to reuse register/stack arenas and swap contexts without copying (see [issues/#2_scheduler](../../issues/#2_scheduler/01--Issue.md)).
- The architecture supports standalone operation (MiniVM without executive) but assumes the executive will take over when present, halting VM’s internal loop and driving execution via `step()`.

## Scheduling overview
- Cooperative round-robin scheduler that advances one MiniVM instruction per task turn, preserving deterministic PID interleaving.
- Task states include ready, running, waiting on mailbox, sleeping, paused, and terminal states; the design specification ([04--Design/04.02--Executive.md](../04--Design/04.02--Executive.md)) details exact transitions and wait/wake rules.
- Mailbox waits and sleep requests yield control back to the scheduler, while external events (timeouts, debugger commands) update task state without re-entering the VM unsafely.
```
READY ─► RUNNING ─► READY
                └─► WAIT_MBX ──(wake/timeout)──► READY
                └─► SLEEPING ──(deadline)──────► READY
                └─► PAUSED / RETURNED (terminal)
```
- Memory footprint targets for the executive (scheduler state, mailbox manager, buffers) are tracked in [docs/resource_budgets.md](../../docs/resource_budgets.md); the AVR baseline allocates ≤5.5 KiB SRAM for the core runtime so that HSX tasks retain sufficient stack space.


## HXE Metadata Preprocessing (v2)
- **Declarative registration:** HXE format version 0x0002 includes metadata sections (`.value`, `.cmd`, `.mailbox`) generated by toolchain from preprocessor directives.
- **Load-time processing:** When executive loads an HXE v2 image, it:
  1. Validates header and locates metadata section table via `meta_offset`/`meta_count` fields.
  2. Parses `.value` section and registers all values with app's PID in executive-owned registry.
  3. Parses `.cmd` section and registers all commands with handler offsets.
  4. Parses `.mailbox` section and creates mailboxes for the app.
  5. Strips metadata sections from image before passing code/rodata/bss to VM.
- **Benefits:** Zero VM cycles for initialization, no registration code in VM memory, deterministic setup before first instruction.
- **Fallback:** Runtime registration via SVCs (VALUE_REGISTER, CMD_REGISTER) remains available for dynamic scenarios but declarative is preferred for static metadata.
- Detailed format specification in [docs/hxe_format.md](../../docs/hxe_format.md) and design workflows in [04--Design/04.07--Provisioning.md](../04--Design/04.07--Provisioning.md).
## Event streaming & debugger integration
- The executive aggregates VM and scheduler events (instruction retire, breakpoint hits, mailbox activity, watchdog notifications) into a bounded queue. Subscribers attach via `events.subscribe`, optionally filtering by PID and event categories.
- Back-pressure is handled through acknowledgements (`events.ack`) and a drop-oldest policy once queues exceed configured depth. Each event carries `seq` (uint64), `ts` (float seconds or ISO8601 string), `pid`, `type`, and a `data` object whose schema is documented in [docs/executive_protocol.md](../../docs/executive_protocol.md).
- Only one debugger may hold a PID lock at a time; additional subscribers may listen in passive mode (read-only) for telemetry panels.
- Event streaming extends the existing RPC transport and underpins the debugger/TUI feature set described in [functionality/#1_TUI_DEBUGGER/04--Design.md](../../functionality/#1_TUI_DEBUGGER/04--Design.md).
