# Project Architecture — HSX Runtime & Tooling

> Define the high-level structure and guiding principles for the HSX platform. Detailed designs live in downstream documents.

## Layered Architecture Overview
```
                   Host-only (desktop)
          +----------------------------------+
          | Shell / Automation / Debugger    |
          |  (full debugger runs here)       |
          +----------------------------------+
                              |
                              | control plane / RPC
+--------------------------------------------------------------+
|                    HSX Applications (.hxe)                   |
|        domain logic tasks produced by toolchain (per PID)    |
+--------------------------------------------------------------+
                              |
+--------------------------------------------------------------+
|                       HSX VM Core (MiniVM)                   |
| executes HSX ISA, maintains register workspace, no scheduler |
+--------------------------------------------------------------+
                              |
+--------------------------------------------------------------+
|                        HSX Executive                         |
| scheduling, IPC/mailboxes, provisioning, value/command APIs  |
+--------------------------------------------------------------+
             | SVC / IPC hooks                  | HAL service calls
             v                                   v
   +---------------------------+      +-------------------------------+
   | Provisioning / Values /   |      |     HAL Drivers & Services    |
   | Command mediation         |      |  UART, CAN, FRAM, FS, GPIO... |
   +---------------------------+      +-------------------+-----------+
                                                        |
                                                        v
                                            +-------------------------+
                                            | MCU I/O, storage, timers |
                                            +-------------------------+
```
- HSX applications sit atop the stack; they always run under MiniVM control.
- Full-featured debugger remains on the host. Embedded targets may ship lightweight shims (e.g., serial forwarders) but not the complete debugger UI.
- Executive mediates all IPC, provisioning, and hardware access; HAL drivers may be native (C) on embedded targets or emulated on host.
- HSX VM core stays shell-less; execution happens via SVC traps and executive-managed context switching.

## System Overview
- **MiniVM:** Single-task interpreter implementing the HSX ISA. Registers are indirected via base pointers to support quick context switching (change register base before executing a step). Runs under control of a native host process; no OS or shell executes inside the VM.
- **Executive:** Native host controller (desktop prototype in Python, embedded version in C) responsible for task scheduling, mailbox management, HAL integration, and mediating access to MiniVM instances. Provides provisioning interfaces to load HSX apps at boot (CAN master, SD card, host preload).
- **Mailbox subsystem:** Multi-subscriber messaging inspired by VMS/RSX-11 semantics. Supports modes such as first-reader-clears and all-readers-clears; central communication channel across tasks and HAL endpoints.
- **Shell:** Command-line client that interacts with the executive for manual control, monitoring, and automation-friendly scripting.
- **Debugger & Toolkit:** Rich tooling layer (CLI + TUI) built atop the executive interface. Intended to remain Python-based; embedded targets may use lightweight shims/HSX tasks to forward events/signals to the host debugger.

## Architectural Principles
- **Layered control:** VM remains unaware of scheduling policies; executive owns task orchestration and mailbox operations.
- **Extensibility:** Python prototypes provide full functionality, with clear abstraction boundaries to enable selective C porting (e.g., MiniVM core, mailbox HAL).
- **Event-driven observability:** Executive centralises trace, breakpoint, and mailbox events so shell/debugger tooling can subscribe without deep VM knowledge.
- **Document alignment:** Architecture/design docs under `main/` are the source of truth. Legacy specs (e.g., `docs/hsx_spec-v2.md`) should be migrated here and retired; capture any behavioural change in the relevant `(3.x)` and `(4.x)` files before implementation proceeds.

## Roadmap Alignment
- Milestones track progressive delivery: MiniVM prototype → Executive features (scheduling, mailbox) → Values/Commands → UART/CAN → Toolkit/Debugger.
- Debugger & tooling milestone is promoted immediately after Milestone 5 (current focus).

## Future Direction
- Plan for C port of MiniVM/executive once Python prototypes are stable and validated, targeting AVR/Cortex‑M hosts.
- Define deployment strategies for provisioning HSX apps across CAN nodes (dynamic load vs. SD fallback).
- Consider repository split for toolkit after architecture solidifies; until then keep system and tooling co-located for coherence.

## Architecture Playbook
- [ ] Document MiniVM view ([03.01--VM.md](03.01--VM.md))
- [ ] Document Executive view ([03.02--Executive.md](03.02--Executive.md))
- [ ] Document Mailbox subsystem ([03.03--Mailbox.md](03.03--Mailbox.md))
- [ ] Document Value & Command layer ([03.04--ValCmd.md](03.04--ValCmd.md))
- [ ] Document Tooling architecture ([03.05--Toolkit.md](03.05--Toolkit.md))
- [ ] Document Provisioning & Persistence ([03.06--Provisioning.md](03.06--Provisioning.md))
- [ ] Capture additional cross-cutting concerns (security, HAL) if needed

## References
- `docs/executive_protocol.md` (to be mirrored/migrated into architecture/design views)
- Feature/refactor packages under `functionality/` and `refactor/`
