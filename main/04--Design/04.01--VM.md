# Design Spec — MiniVM

## Scope
- Execute HSX ISA for a single task under executive control (DG-4.1, DG-5.4).
- Maintain per-task architectural state (workspace pointer, stack pointers, flags) without an in-VM OS (DR-2.1, DR-2.1a, DG-2.1, DG-4.1).
- Provide debugging hooks (breakpoints, run-to-PC, instruction trace) surfaced through the executive (DR-8.1, DG-4.2).

## Preconditions
- Executive supplies task lifecycle control, memory allocation for register/stack regions, and RPC endpoints for load/step operations (DR-5.1, DR-5.2, DG-5.1).
- Toolchain emits .hxe binaries with entry point metadata and (when available) symbol/line tables for debugging (DR-3.1, DG-3.1, DG-3.3).
- Mailbox/value/command services in the executive are ready to service SVC traps initiated by MiniVM tasks (DR-6.1, DR-7.1, DG-6.1, DG-7.2).

## Postconditions
- MiniVM can be swapped between Python reference and C port without breaking ISA semantics or debugger expectations (DR-1.3, DG-1.4).
- Tasks can be loaded, executed, paused, and context switched using the register workspace model managed by the executive (DR-2.1, DG-4.1).
- Debug traps (BRK, SVC) emit structured events compatible with the executive event streaming contract (DR-8.1, DG-5.2).

## Data Structures
- **Register workspace:** contiguous 16×32-bit registers stored in RAM; `reg_base` points to active window.
- **Task context:** struct containing `pc`, `reg_base`, `stack_base`, `sp`, `psw`, sleep state, and mailbox wait metadata.
- **Debug/event state:** per-task flags (`debug_enabled`, `breakpoints`, `single_step_remaining`) and pending event buffer consumed by executive.

## Algorithms / Behaviour
- **Fetch/decode/execute:** 16-bit opcode fetch with extension words; operations update register workspace and memory.
- **Context switching:** executive repoints `reg_base`/`stack_base` before invoking `step`; no register copying required.
- **Trap handling:** SVC captures argument registers (`R0-R3`) and posts events; BRK halts execution, records stop reason, and notifies executive.
- **Debug flow:** honour `debug_breakpoints`, `single_step_remaining`, and async break requests before executing instructions.
- **Sleep semantics:** `request_sleep` records delay; when not attached, VM waits locally; when attached, executive handles scheduling.

## Edge Cases
- Register workspace overflow/underflow when instructions compute out-of-range addresses (trap to error event).
- Mailbox wait handling when executive detached (fall back to internal scheduler loops).
- Safe behaviour when task sleeps while debug single-step active (ensure wake resumes at correct breakpoint state).

## Testing Considerations
- ISA compliance via `python/tests/test_ir2asm` and new opcode coverage tests.
- Breakpoint/run-to-PC regressions (verify `debug_stop` events, skip logic, async break).
- Standalone vs executive-attached scenarios (`python/tests/test_vm_pause`, manual smoke using `host_vm.py`).

## Traceability`n- **Design Requirements:** DR-1.3, DR-2.1, DR-2.1a, DR-2.2, DR-2.3, DR-3.1, DR-5.1, DR-5.2, DR-6.1, DR-7.1, DR-8.1.`n- **Design Goals:** DG-1.3, DG-1.4, DG-2.1–2.4, DG-3.1–3.3, DG-4.1–4.3, DG-5.1–5.4, DG-6.1, DG-7.2.`n- **Design Options:** DO-2.a, DO-VM-hotset, DO-VM-adaptive, DO-4.b.`n
- **Design Requirements:** DR-1.3, DR-2.1, DR-2.1a, DR-2.2, DR-2.3, DR-3.1, DR-5.1, DR-5.2, DR-6.1, DR-7.1, DR-8.1.
- **Design Goals:** DG-1.3, DG-1.4, DG-2.1–2.4, DG-3.1–3.3, DG-4.1–4.3, DG-5.1–5.4, DG-6.1, DG-7.2.
- **Design Requirements:** DR-1.3, DR-2.1, DR-2.1a, DR-2.2, DR-2.3, DR-3.1, DR-5.1, DR-5.2, DR-6.1, DR-7.1, DR-8.1.
- **Design Goals:** DG-1.3, DG-1.4, DG-2.1–2.4, DG-3.1–3.3, DG-4.1–4.3, DG-5.1–5.4, DG-6.1, DG-7.2.
- **Design Options:** DO-2.a, DO-VM-hotset, DO-VM-adaptive, DO-4.b.
