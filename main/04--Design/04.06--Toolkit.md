# Design Spec - Tooling (Shell, Debugger & Manager)
# 04.06--Toolkit Design (v3, repo style)
**Status:** DRAFT | **Date:** 2025-10-31 | **Owner:** HSX Core

> **Design stance:** The toolkit provides user-facing interfaces to the HSX runtime. It performs no autonomous scheduling, embeds no VM logic, and coordinates all operations through the executive RPC protocol. All debugging and control actions are explicitly driven by user commands.

**Authoritative context (repo-local):**
- Architecture: [03.06--Toolkit](../03--Architecture/03.06--Toolkit.md), [03.00--Architecture](../03--Architecture/03.00--Architecture.md)
- Study & Requirements: [02--Study](../02--Study/02--Study.md), [02.01--Requirements](../02--Study/02.01--Requirements.md)
- Debugger specifications: [04.09--Debugger.md](04.09--Debugger.md), [04.10--TUI_Debugger.md](04.10--TUI_Debugger.md), [04.11--vscode_debugger.md](04.11--vscode_debugger.md)
- Implementation-phase specs (normative inputs referenced by design):
  [docs/executive_protocol.md](../../docs/executive_protocol.md), [docs/abi_syscalls.md](../../docs/abi_syscalls.md)

**Traceability (fill from 02.01--Requirements):** Refs DR[..], DG[..], DO[..].

## 1. Scope
- Process manager for coordinating HSX runtime components (MiniVM, Executive, Shell) (DR-8.1, DG-8.1).
- Interactive CLI and TUI debugger interfaces (see [04.09--Debugger.md](04.09--Debugger.md) and [04.10--TUI_Debugger.md](04.10--TUI_Debugger.md)).
- IDE integration via Debug Adapter Protocol for VS Code and compatible editors (see [04.11--vscode_debugger.md](04.11--vscode_debugger.md)).
- Automation support via JSON output and scripting API for CI/CD integration (DG-8.3).
- Cross-platform packaging and distribution for Windows, macOS, and Linux (DG-8.3).

## 2. Preconditions
- MiniVM executable or Python implementation available on target platform (DR-1.1, DG-1.2).
- Executive implements management and debugger RPCs per [docs/executive_protocol.md](../../docs/executive_protocol.md) (DR-8.1, DG-8.2).
- Toolchain provides symbol metadata for debugging features (DR-3.1, DG-3.3, DG-3.5).
- Runtime environment has ANSI-capable terminal support (Windows PowerShell, macOS Terminal, Linux terminals) (DG-8.3).
- Python 3.8+ available for manager and debugger tools (DG-8.3).

## 3. Postconditions
- `hsx_manager.py` provides unified interface for starting/stopping runtime components (DR-8.1, DG-8.1).
- Debugger tools (`hsxdbg` CLI and TUI) enable runtime inspection and control per [04.09--Debugger.md](04.09--Debugger.md) and [04.10--TUI_Debugger.md](04.10--TUI_Debugger.md) (DR-8.1, DG-8.1).
- IDE integration via Debug Adapter Protocol enables source-level debugging per [04.11--vscode_debugger.md](04.11--vscode_debugger.md) (DG-8.1, DG-8.3).
- Packaging scripts deliver cross-platform distributions with comprehensive documentation (DG-8.3).
- Users can manage, debug, and control HSX runtime without behavioral differences across platforms (DR-1.3, DG-1.4, DG-8.3).

## 4. Architectural Overview

### 4.1 Design Principles
- **Process management:** Coordinated lifecycle for VM, Executive, and Shell components.
- **Executive-driven control:** All runtime manipulation flows through executive RPC; toolkit maintains no local VM state beyond caches.
- **Modular frontends:** CLI, TUI, and IDE integrations share common debugger core.
- **Platform portability:** Unified codebase supports Windows, macOS, Linux via Python cross-platform libraries.

### 4.2 Component Architecture
- **Manager (`hsx_manager.py`):** Process lifecycle coordinator for MiniVM, Executive, and Shell.
- **Debugger core (`hsxdbg`):** Session management, event bus, RPC client (see [04.09--Debugger.md](04.09--Debugger.md)).
- **CLI frontend:** Command parser, JSON output, script execution (see [04.09--Debugger.md](04.09--Debugger.md)).
- **TUI frontend:** Textual-based visual debugger (see [04.10--TUI_Debugger.md](04.10--TUI_Debugger.md)).
- **IDE integration:** Debug Adapter Protocol for VS Code (see [04.11--vscode_debugger.md](04.11--vscode_debugger.md)).
- **Packaging:** Cross-platform installers and documentation bundles.

## 5. External Interfaces

### 5.1 Manager Commands (`hsx_manager.py`)
| Command | Arguments | Description |
|---------|-----------|-------------|
| `start` | `[vm\|exec\|shell\|all]` | Start specified component(s). |
| `stop` | `[vm\|exec\|shell\|all]` | Stop specified component(s). |
| `restart` | `[vm\|exec\|shell\|all]` | Restart specified component(s). |
| `status` | - | Display status of all components. |
| `load` | `<path.hxe>` | Load executable into runtime via executive. |
| `shell` | - | Spawn new shell client window. |
| `quit` / `exit` | - | Shutdown all components and exit. |

**Managed Components:**
- **vm:** MiniVM process (`host_vm.py`) listening on TCP port (default 9999).
- **exec:** Executive daemon (`execd.py`) connecting to VM and listening on TCP port (default 9998).
- **shell:** Shell client (`shell_client.py`) connecting to executive for interactive commands.

### 5.2 Debugger Interfaces
See detailed specifications in dedicated documents:
- **CLI debugger commands:** [04.09--Debugger.md](04.09--Debugger.md) Section 6
- **TUI panels and shortcuts:** [04.10--TUI_Debugger.md](04.10--TUI_Debugger.md) Sections 5-7
- **VS Code integration:** [04.11--vscode_debugger.md](04.11--vscode_debugger.md)

## 6. Manager Design Details

### 6.1 Process Coordination
The HSX manager (`hsx_manager.py`) is responsible for coordinating the lifecycle of runtime components:

**Component Startup Order:**
1. **MiniVM** starts first and opens TCP listener on configured port
2. **Executive** starts after VM is ready, connects to VM, opens its own TCP listener
3. **Shell** can be started after executive is ready, connects to executive for interactive control

**Dependency Management:**
- Manager verifies VM port is listening before starting executive
- Manager verifies executive port is listening before allowing shell connections
- Automatic retry with timeout if connections fail

**Platform-Specific Behavior:**
- **Windows:** Shell spawns in new console window via `CREATE_NEW_CONSOLE` flag
- **POSIX:** Shell spawns in external terminal (x-terminal-emulator, xterm) if available
- **Fallback:** If no external terminal available, shell runs inline within manager console

### 6.2 Implementation Status
The manager implementation (`python/hsx_manager.py`) is **already implemented** in the Python reference implementation. This design document represents reverse-engineered documentation of the existing functionality.

**Key Features Implemented:**
- Interactive command prompt with help system
- Component lifecycle management (start/stop/restart)
- Status monitoring for all components
- Load command forwarding to executive
- Graceful shutdown with timeout handling
- Cross-platform terminal detection and spawning

### 6.3 Future Enhancements
- **Logging:** Capture component stdout/stderr to log files
- **Configuration:** Support config file for default ports and paths
- **Health checks:** Periodic verification of component health
- **Automated restart:** Detect crashes and restart components automatically

## 7. Edge Cases and Error Handling

### 7.1 Manager Error Handling
- **Port conflicts:** Detect port already in use and report to user with suggestion to change port
- **Component crashes:** Detect process termination and report exit code
- **Timeout on startup:** Kill process if port doesn't open within timeout
- **Graceful shutdown:** Send SIGTERM, wait for exit, then SIGKILL if timeout

### 7.2 Debugger Error Handling
- **Executive protocol mismatch:** Downgrade to polling or warn user (see [04.09--Debugger.md](04.09--Debugger.md) Section 7)
- **Event back-pressure:** Detect queue overflow, request slow-down (see [04.09--Debugger.md](04.09--Debugger.md) Section 5.2.3)
- **Connection loss:** Auto-retry with exponential backoff (see [04.09--Debugger.md](04.09--Debugger.md) Section 7.2)
- **Session conflicts:** Clear messaging for PID lock contention (see [04.09--Debugger.md](04.09--Debugger.md) Section 5.1.2)

## 8. Testing Strategy

### 8.1 Manager Testing
- **Unit tests:** Component lifecycle state machine, command parsing, port availability checks.
- **Integration tests:** Full startup/shutdown sequences, component crash handling, port conflict detection.
- **Cross-platform validation:** Windows console behavior, POSIX terminal detection and spawning.

### 8.2 Debugger Testing
See detailed testing strategies in:
- **CLI debugger:** [04.09--Debugger.md](04.09--Debugger.md) Section 8
- **TUI debugger:** [04.10--TUI_Debugger.md](04.10--TUI_Debugger.md) Section 11
- **VS Code integration:** [04.11--vscode_debugger.md](04.11--vscode_debugger.md)

## 9. Verification
- See [Toolkit_tests.md](../06--Test/system/Toolkit_tests.md) (if available).
- **Manager verification:** Process lifecycle correctness, error handling, cross-platform behavior.
- **Debugger verification:** See [04.09--Debugger.md](04.09--Debugger.md) and [04.10--TUI_Debugger.md](04.10--TUI_Debugger.md).
- **Integration verification:** Manager + debugger workflows, component coordination.

## 10. Traceability
- **Design Requirements:** DR-1.3, DR-3.1, DR-8.1.
- **Design Goals:** DG-1.4, DG-8.1, DG-8.2, DG-8.3.
- **Design Options:** DO-relay (future remote debugging), DO-8.a (advanced TUI features).

