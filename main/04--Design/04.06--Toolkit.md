# Design Spec - Tooling (Shell & Debugger)
# 04.06--Toolkit Design (v3, repo style)
**Status:** DRAFT | **Date:** 2025-10-28 | **Owner:** HSX Core

> **Design stance:** The toolkit provides user-facing interfaces to the HSX runtime. It performs no autonomous scheduling, embeds no VM logic, and coordinates all operations through the executive RPC protocol. All debugging and control actions are explicitly driven by user commands.

**Authoritative context (repo-local):**
- Architecture: [03.06--Toolkit](../03--Architecture/03.06--Toolkit.md), [03.00--Architecture](../03--Architecture/03.00--Architecture.md)
- Study & Requirements: [02--Study](../02--Study/02--Study.md), [02.01--Requirements](../02--Study/02.01--Requirements.md)
- Implementation-phase specs (normative inputs referenced by design):
  [docs/executive_protocol.md](../../docs/executive_protocol.md), [docs/abi_syscalls.md](../../docs/abi_syscalls.md)

**Traceability (fill from 02.01--Requirements):** Refs DR[..], DG[..], DO[..].

## 1. Scope
- Interactive CLI and TUI (Textual-based) debugger for HSX runtime control, inspection, and diagnostics (DR-8.1, DG-8.1).
- Session management, event streaming, breakpoint/watchpoint coordination with executive (DR-8.1, DG-8.2).
- Automation support via JSON output and scripting API for CI/CD integration (DG-8.3).
- Cross-platform packaging and distribution for Windows, macOS, and Linux (DG-8.3).

## 2. Preconditions
- Executive implements debugger session/event RPCs (`session.open`, `events.subscribe`, etc.) and enforces PID locks per [docs/executive_protocol.md](../../docs/executive_protocol.md) (DR-8.1, DG-8.2).
- Toolchain provides symbol metadata and watch descriptors required for disassembly, stack reconstruction, and watch panels (DR-3.1, DG-3.3, DG-3.5).
- MiniVM and executive emit structured events (`trace_step`, `debug_break`, `mailbox_*`, `scheduler`, `watch_update`, `stdout/stderr`) (DR-8.1, DG-5.2).
- Runtime environment has ANSI-capable terminal support (Windows PowerShell, macOS Terminal, Linux terminals) (DG-8.3).

## 3. Postconditions
- `hsxdbg` package exposes shared session/event core consumed by CLI (`hsx dbg`) and TUI (Textual) frontends (DR-8.1, DG-8.1).
- Tooling handles back-pressure, filtering, and reconnection per debugger design and [docs/executive_protocol.md](../../docs/executive_protocol.md) (DR-8.1, DG-8.2).
- Packaging scripts deliver cross-platform distributions with comprehensive documentation reflecting commands and panels (DG-8.3).
- Users can attach, inspect, control, and detach from HSX runtime without behavioral differences across platforms (DR-1.3, DG-1.4, DG-8.3).

## 4. Architectural Overview

### 4.1 Design Principles
- **Executive-driven control:** All runtime manipulation flows through executive RPC; toolkit maintains no local VM state beyond caches.
- **Event-driven updates:** UI refreshes triggered by structured event stream; no polling loops.
- **Session isolation:** PID locks prevent conflicting control; observer mode allows read-only monitoring.
- **Platform portability:** Unified codebase supports Windows, macOS, Linux via Python cross-platform libraries.

### 4.2 Component Architecture
- **Core (`hsxdbg`):** Session management, event bus, RPC client, cache management.
- **CLI frontend:** Command parser, JSON output, script execution.
- **TUI frontend:** Textual-based panels (registers, disassembly, stack, watch, mailbox, console).
- **Packaging:** Cross-platform installers and documentation bundles.

## 5. External Interfaces

### 5.1 CLI Commands
| Command | Arguments | Description |
|---------|-----------|-------------|
| `attach` | `[pid]` | Attach debugger session to PID or auto-select. |
| `detach` | - | Release session and PID lock. |
| `step` | `[n]` | Single-step n instructions (default 1). |
| `continue` | - | Resume execution until breakpoint or completion. |
| `break` | `<addr|symbol>` | Set breakpoint at address or symbol. |
| `watch` | `<oid>` | Watch value changes for given OID. |
| `ps` | `[pid]` | List tasks or show details for PID. |
| `reg` | `[name] [value]` | Read or write register. |
| `mem` | `<addr> <len>` | Dump memory region. |

### 5.2 TUI Panels
- **Registers:** Display R0-R15, PC, SP, PSW with highlighting on changes.
- **Disassembly:** Show instructions around PC with symbols and breakpoint markers.
- **Stack:** Reconstruct call stack with frame pointers and local variables.
- **Watch:** Live value/command table with change highlighting.
- **Mailbox:** Monitor descriptor activity (depth, bytes_used, recent messages).
- **Console:** Stdio output and command input.

## 6. Edge Cases and Error Handling
- **Executive protocol mismatch:** Downgrade to polling or warn user; ensure backwards compatibility with legacy servers.
- **Event back-pressure:** Detect queue overflow, request slow-down, resynchronize caches when gaps detected.
- **Connection loss:** Auto-retry with exponential backoff; preserve local state for reconnection; inform user of stale data.
- **Concurrent operations:** Sessions competing for same PID result in clear UX messaging; observer mode provides read-only access.

## 7. Testing Strategy
- **Unit tests:** CLI parsing, JSON output formatting, event bus transformations.
- **Integration tests:** Attach to simulated executive, breakpoint/step/watch workflows, event reconnect.
- **Cross-platform validation:** Windows PowerShell, macOS Terminal, Linux/tmux rendering and keymaps.
- **Regression tests:** Event reconnect and drop-handling, session lock conflicts.

## 8. Verification
- See [Toolkit_tests.md](../06--Test/system/Toolkit_tests.md) (if available).
- **Contract coverage:** Session lifecycle, PID locks, event ACK protocol.
- **Behavioral coverage:** Breakpoint hit detection, watch notifications, stack reconstruction accuracy.
- **Usability testing:** Manual checklist for TUI responsiveness and CLI ergonomics.

## 9. Traceability
- **Design Requirements:** DR-1.3, DR-3.1, DR-8.1.
- **Design Goals:** DG-1.4, DG-8.1, DG-8.2, DG-8.3.
- **Design Options:** DO-relay (future remote debugging), DO-8.a (advanced TUI features).

