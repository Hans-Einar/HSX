# Design Spec — Tooling (Shell & Debugger)

## Preconditions
- Executive implements debugger session/event RPCs (`session.open`, `events.subscribe`, etc.) and enforces PID locks.
- Toolchain provides symbol metadata and watch descriptors required for disassembly/stack/watch panels.
- MiniVM/executive emit structured events (`trace_step`, `debug_break`, `mailbox_*`, `scheduler`, `watch_update`, `stdout/stderr`).
- Runtime environment has ANSI-capable terminal support (Windows PowerShell, macOS Terminal, Linux terminals).

## Postconditions
- hsxdbg package exposes a shared session/event core consumed by CLI (hsx dbg) and TUI (Textual) frontends (DR-8.1, DG-8.1).
- Tooling handles back-pressure, filtering, and reconnection per the debugger design and docs/executive_protocol.md (DR-8.1, DG-8.2).
- Packaging scripts deliver cross-platform distributions, and documentation reflects new commands and panels (DG-8.3).

## Scope
- Provide interactive CLI for manual control, scripting, and diagnostics (DG-8.1).
- Deliver debugger experience (CLI + TUI) via shared core (hsxdbg) handling sessions, breakpoints, and watch state (DR-8.1, DG-8.1).
- Support automation workflows (JSON output, scripting API) and packaging/release processes (DG-8.3).

## Data Structures
- **Shell command registry:** mapping command name → handler, documentation, JSON flag.
- **Debugger session model:** connection info, attached PID, capability set, watch/breakpoint tables.
- **Event bus:** queue/type filters feeding CLI/TUI; includes back-pressure metrics and last-seen sequence numbers.
- **State cache:** per-PID snapshots (registers, stack frames, memory ranges, values) for incremental UI updates.
- **UI models:** panel descriptors for Textual layout, prompt_toolkit key bindings/history.

## Algorithms / Behaviour
- **Shell:** parse command (attach, clock, val, cmd, mbox), call executive RPC, render text/JSON. Support `ps <pid>` filter, `val get group:id` addressing, `listen` for stdio.
- **Debugger attach:** negotiate capabilities, lock PID, start event subscription, seed caches (registers, symbols, values).
- **Event processing:** fan events through bus, update caches, trigger UI refresh; handle drop-oldest by resyncing state.
- **Watch/breakpoint management:** map symbols to addresses, sync with executive (`debug_breakpoints`), update UI on change.
- **TUI loop:** Textual application scheduling updates, key bindings for stepping, breakpoints, panel focus.
- **Automation:** `hsx dbg --json` output, scripting API exposing session methods.
- **Packaging:** `make dev-env` for dependencies; `make package/release` flatten CLI + debugger entry points following the checklist in `docs/packaging.md` (metadata sidecars, docs bundle, manifests).
- **Event protocol:** tooling mirrors `docs/executive_protocol.md` (version 1). Support `session.open/keepalive/close`, `events.subscribe/ack/unsubscribe`, apply category filters, and surface back-pressure via UI warnings.
- **Drop handling & resync:** detect gaps via missing `seq` ranges; request resynchronisation (`since_seq`) or issue explicit refresh (re-fetch registers/stack/mailboxes) to rebuild cache after drops.
- **Observer sessions:** allow read-only attaches (no `pid_lock`) so dashboards can stream telemetry without blocking owners. Observer clients must still ACK sequences, respect throttling hints, and auto-recover if evicted for back-pressure.
- **Filtering:** allow per-panel category filters (trace, scheduler, mailbox, watch, stdout/stderr) with configurable rate limits to keep TUI responsive.

## Edge Cases
- Executive protocol mismatch: downgrade to polling or warn user; ensure backwards compatibility with legacy servers lacking event stream.
- Event back-pressure: detect queue overflow, request slow-down, resynchronise caches when gaps detected.
- Connection loss: auto-retry with exponential backoff; preserve local state for reconnection; inform user of potential stale data.
- Concurrent CLI/Debugger operations on same host; ensure shared configuration (history files, workspace paths) handled safely.
- Sessions competing for same PID should result in clear UX messaging; eventual observer mode must be read-only.

## Testing Considerations
- Unit tests for CLI parsing, JSON output formatting, event bus transformations.
- Integration tests attaching to simulated executive (`python/tests/test_host_vm_cli.py`, new debugger pipelines) covering attach-run-detach, breakpoints, value watch.
- Snapshot/visual tests for Textual panels (registers, trace, watch list) and prompt_toolkit key bindings.
- Cross-platform manual checklist (Windows PowerShell, macOS Terminal, Linux/tmux) ensuring rendering and keymaps behave.
- Regression tests for event reconnect and drop-handling once protocol finalised.

## Traceability
- **Design Requirements:** DR-3.1, DR-8.1.
- **Design Goals:** DG-8.1�8.3.
- **Design Options:** DO-relay.

