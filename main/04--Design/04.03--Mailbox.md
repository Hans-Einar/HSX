# Design Spec – Mailbox Subsystem

## Preconditions
- Executive scheduler/event system available to drive mailbox wait/wake transitions (DR-5.1, DG-5.1, DG-5.2).
- MiniVM SVC dispatch routes mailbox operations through executive handlers per DG-6 studies (DR-6.1, DG-6.1�6.3).
- System memory budgets configured as in docs/resource_budgets.md (descriptor pool, ring capacity, staging buffers) (DR-5.2, DG-6.2).

## Postconditions
- Mailbox subsystem delivers configurable delivery modes (single-reader, fan-out, taps) with documented policies for blocking, dropping, and taps (DR-6.1, DG-6.1�6.4).
- Instrumentation and event streaming emit mailbox_send, mailbox_recv, mailbox_timeout, and overrun warnings for debugger/tooling consumption (DR-8.1, DG-6.2, DG-8.2).
- Resource usage stays within target budgets and can be tuned per platform profile (DR-5.2, DG-6.2).

## Scope
- Executive-owned mailbox service providing task-to-task and host IPC.
- Supports namespaces (`svc`, `pid`, `app`, `shared`) with configurable delivery semantics (single-reader, fan-out, taps).
- Provides stdio streams, telemetry fan-out, and shell/debugger integrations while remaining portable to the Python prototype and the C executive.

## Data Structures
- **Descriptor:** `descriptor_id`, namespace tag, name, owner PID, capacity (bytes), mode mask, queue (`deque[MailboxMessage]`), bytes used, waiters (`List[int]`), taps (`List[int]`), `head_seq`, `next_seq`. Capacity enforcement uses `bytes_used` and message cost (`payload_len + 8` header bytes). Mode flags cover `HSX_MBX_MODE_RDONLY`, `WRONLY`, `RDWR`, `TAP`, `FANOUT`, `FANOUT_DROP`, and `FANOUT_BLOCK`.
- **HandleState:** per-task handle record containing `descriptor_id`, `last_seq`, `pending_overrun`, `is_sender`.
- **MailboxMessage:** header (length, flags, src_pid, channel) plus payload; matches `hsx_mbx_msg_header_t` so native firmware can share the layout.
- **Wait queues:** descriptor-level list of blocked receivers/senders plus timeout metadata consulted by the scheduler each tick.
- **Namespace index:** dictionary keyed by `(namespace, name, owner_pid)` mapping to descriptor IDs for deterministic lookups across host and embedded builds.

## Algorithms / Behaviour
- **Bind/Open:** parse target, normalise namespace, create descriptor when required. `svc:` initialises stdio/control mailboxes per PID; `pid:` provides private control channels; `shared:` defaults to fan-out mode.
- **Send:** build `MailboxMessage`, ensure available capacity, enqueue, and notify waiters.
  - Non fan-out: append to queue, wake one waiting receiver.
  - Fan-out: reclaim acknowledged messages, enforce `FANOUT_BLOCK`/`FANOUT_DROP`, advance per-handle `last_seq`, wake all readers with pending data. Zero-length payloads always succeed (wake hint).
- **Recv:** deliver next message. Fan-out advances by sequence number; single-reader pops queue head. When no data is available the executive records the PID in the wait list and returns a poll/timeout status.
- **Tap:** maintain a tap list; taps receive non-destructive copies and should not block the owner. Best-effort drop-on-overflow with `HSX_MBX_FLAG_OVERRUN`.
- **Timeouts:** scheduler decrements timers for blocked tasks, removes PIDs on expiry, emits `mailbox_timeout`, and returns timeout status to the caller.
- **Fairness:** wait queues operate FIFO; scheduler counters (`MAILBOX_STEP`, `MAILBOX_WAKE`) track behaviour for diagnostics.
- **Resource quotas:** descriptor pool size, per-task handle limit, and default capacity follow `docs/resource_budgets.md`. Embedded AVR profile starts with ≈16 descriptors, 64-byte rings, and ≤1 KiB metadata.
- **Resource monitoring:** mailbox manager exposes descriptor depth/bytes-used versus configured capacity so tests can assert SRAM usage stays within the budgets.

## State diagrams
```text
                   +-------------+
                   |   READY     |
                   +------+------+
                          |
                          | scheduler selects PID
                          v
                   +-------------+
                   |   RUNNING   |
                   +------+------+-------------------------------+
                          |                                      |
        MAILBOX_RECV with | data                                 | MAILBOX_RECV (no data)
        data available    v                                      v  (blocking & timeout ≠ POLL)
                  +---------------+                     +---------------------+
                  | delivery path |                     |     WAIT_MBX        |
                  +-------+-------+                     +----+----------+-----+
                          |                                  |          |
                          |                                  | timeout  | mailbox wake
                          |                                  v          v
                          |                           +--------------+  |
                          |                           |  TIMEOUT (*) |  |
                          |                           +------+-------+  |
                          |                                  |          |
                          | scheduler yields                  | status   |
                          v                                  v          |
                   +-------------+                       +-------------+
                   |   READY     |<-----------------------|   READY     |
                   +-------------+        unblock         +-------------+
```
(*) Timeout currently returns `HSX_MBX_STATUS_WOULDBLOCK`; ABI will add a dedicated timeout code.

### Send-side back-pressure
```text
RUNNING --MAILBOX_SEND-->
    success -------------------------------> READY (post-quantum)
    |
    +-- ring full + blocking policy ------> WAIT_MBX (sender queue)
                                             |
                                             | space freed / wake
                                             v
                                           READY
```

## Wait/Wake flow example
1. Task A issues `MAILBOX_RECV` with `timeout = HSX_MBX_TIMEOUT_INFINITE`. No messages are present, so the executive adds PID(A) to the descriptor wait list, marks the task `WAIT_MBX`, and emits `mailbox_wait`.
2. Task B sends a message. The descriptor enqueues the payload, sets overrun flags if required, and wakes PID(A). Events `mailbox_send` and `mailbox_wake` are emitted.
3. Scheduler picks PID(A); the pending `MAILBOX_RECV` completes with `HSX_MBX_STATUS_OK`, returning length/flags/channel/src_pid in `R1–R4`.
4. If the timeout expired first, the scheduler would emit `mailbox_timeout`, transition PID(A) back to `READY`, and the trap would return `HSX_MBX_STATUS_WOULDBLOCK` (upgrade to dedicated timeout once available).

## Edge Cases
- Descriptor exhaustion → `HSX_MBX_STATUS_NO_DESCRIPTOR` with diagnostic trace.
- Handle leaks → on task exit iterate handle table, close handles, and free descriptors when reference count hits zero.
- Stdio tapping → ensure stdout fan-out prioritises owner before taps; respect rate limits.
- Embedded profile → obey SRAM caps from `docs/resource_budgets.md`; namespace features may be disabled/tuned per target.
- Provisioning reload → flush descriptors tied to terminated PIDs, revoke handles, notify taps.
- Value/command subscriptions → coalesce bursts before publishing to avoid mailbox saturation.
- Sender starvation → maintain FIFO order for wake-ups so slow taps cannot starve the owner.

## Testing Considerations
- Unit coverage for bind/open permutations, blocking send/recv, timeout paths, and overrun signalling.
- Integration coverage for stdio bridging, `val.sub` pipelines, and shell `listen` flows.
- Stress tests for high-rate producers, mixed drop/block policies, and slow tap consumers.
- Fairness metrics confirming FIFO waiter rotation and absence of starvation.
- Resource budget checks comparing descriptor depth and SRAM usage against `docs/resource_budgets.md`.

## SVC API (module 0x05)
| Fn | Name            | Arguments (`R1..R5`)                                 | Return (`R0..R4`)                                   | Notes |
|----|-----------------|------------------------------------------------------|-----------------------------------------------------|-------|
| 0x00 | `MAILBOX_OPEN` | `target_ptr`, `flags`                               | `R0=status`, `R1=handle`                            | Acquire handle; flags mirror RD/WR intent. |
| 0x01 | `MAILBOX_BIND` | `target_ptr`, `capacity`, `mode_mask`               | `R0=status`, `R1=descriptor`                        | Create/update descriptor; capacity 0 → default. |
| 0x02 | `MAILBOX_SEND` | `handle`, `payload_ptr`, `length`, `flags`, `channel` | `R0=status`, `R1=bytes_sent`                      | Returns `WOULDBLOCK` if capacity exhausted and policy forbids drop; zero-length payloads succeed. |
| 0x03 | `MAILBOX_RECV` | `handle`, `buffer_ptr`, `max_len`, `timeout`, `info_ptr` | `R0=status`, `R1=len`, `R2=flags`, `R3=channel`, `R4=src_pid` | Blocking integrates with scheduler; optional info struct mirrors `hsx_mailbox_recv_info`. |
| 0x04 | `MAILBOX_PEEK` | `handle`                                           | `R0=status`, `R1=depth`, `R2=bytes_used`, `R3=next_len` | Non-destructive queue stats; fan-out aware. |
| 0x05 | `MAILBOX_TAP`  | `handle`, `enable`                                 | `R0=status`                                         | Toggle tap membership. |
| 0x06 | `MAILBOX_CLOSE`| `handle`                                           | `R0=status`                                         | Release handle; descriptor freed when refcount reaches zero. |

- Status codes follow `include/hsx_mailbox.h`: `HSX_MBX_STATUS_OK`, `WOULDBLOCK`, `INVALID_HANDLE`, `NO_DATA`, `MSG_TOO_LARGE`, `INTERNAL_ERROR`. Add `HSX_MBX_STATUS_TIMEOUT` once scheduler timeout plumbing lands.
- Timeout semantics: `HSX_MBX_TIMEOUT_POLL` (0) for immediate return, `1..0xFFFE` for millisecond deadlines (host prototype uses monotonic clock), `HSX_MBX_TIMEOUT_INFINITE` to block indefinitely.
- Namespace rules: `svc:` reserved for executive services, `pid:` auto-generated per task, `app:` for domain sharing, `shared:` for broadcast/fan-out. Enforce `HSX_MBX_MAX_NAME_BYTES` and ASCII filter for predictable footprints.
- Instrumentation: optional trace file logs SVC snapshots; RPC `mailbox_snapshot` exposes descriptor stats. Event stream emits `mailbox_send`, `mailbox_recv`, `mailbox_wait`, `mailbox_wake`, `mailbox_timeout`, `mailbox_error`.

## Traceability
- **Design Requirements:** DR-5.1, DR-5.2, DR-6.1, DR-8.1.
- **Design Goals:** DG-5.1�5.3, DG-6.1�6.4.
- **Design Options:** DO-6.a.

