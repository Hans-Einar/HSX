# Design Spec - TUI Debugger
# 04.10--TUI_Debugger Design (v3, repo style)
**Status:** DRAFT | **Date:** 2025-10-30 | **Owner:** HSX Core

> **Design stance:** The TUI debugger is a full-screen terminal interface providing real-time visualization and control of HSX runtime state. It is built on the debugger core and protocol defined in [04.09--Debugger.md](04.09--Debugger.md), performing no direct VM manipulation and coordinating all operations through the executive RPC.

**Authoritative context (repo-local):**
- Debugger Protocol: [04.09--Debugger.md](04.09--Debugger.md)
- Architecture: [03.06--Toolkit](../03--Architecture/03.06--Toolkit.md), [03.00--Architecture](../03--Architecture/03.00--Architecture.md)
- Study & Requirements: [02--Study](../02--Study/02--Study.md), [02.01--Requirements](../02--Study/02.01--Requirements.md)
- Implementation-phase specs: [docs/executive_protocol.md](../../docs/executive_protocol.md)

**Traceability (fill from 02.01--Requirements):** Refs DR-8.1, DG-8.1, DG-8.2, DG-8.3.

## 1. Scope
- Full-screen terminal user interface (TUI) for HSX debugger with real-time state visualization (DR-8.1, DG-8.1).
- Modular panel-based layout showing registers, disassembly, execution trace, call stack, memory inspector, watch list, and auxiliary views (DR-8.1, DG-8.1).
- Event-driven updates with internal refresh clock for responsive UI without manual polling (DR-8.1, DG-8.2).
- Keyboard-driven navigation and control with consistent shortcuts across panels (DG-8.1, DG-8.3).
- Cross-platform support for Windows PowerShell, macOS Terminal, and Linux terminals (DG-8.3).

## 2. Preconditions
- Debugger core package (`hsxdbg`) provides session management, event streaming, and state caching per [04.09--Debugger.md](04.09--Debugger.md) (DR-8.1, DG-8.2).
- Executive implements debugger protocol with event subscription and structured event delivery (DR-8.1, DG-8.2).
- Symbol metadata available from toolchain for disassembly annotations and watch expressions (DR-3.1, DG-3.3).
- Terminal environment supports ANSI escape sequences and has minimum dimensions of 80x24 characters (DG-8.3).

## 3. Postconditions
- TUI provides intuitive interface for debugging HSX applications with minimal learning curve (DR-8.1, DG-8.1).
- Panels update in real-time (<200ms) when executive emits events or user performs actions (DR-8.1, DG-8.2).
- Users can navigate, inspect, and control execution using only keyboard shortcuts (DG-8.1, DG-8.3).
- Layout adapts to terminal size with responsive resizing behavior (DG-8.3).

## 4. Architectural Overview

### 4.1 Design Principles
- **Event-driven UI:** All panel updates triggered by events from debugger core; no polling loops.
- **Modular panels:** Each view (registers, disassembly, trace, etc.) is an independent component subscribing to relevant events.
- **Keyboard-first:** All functionality accessible via keyboard shortcuts; mouse support optional.
- **Responsive layout:** Panels resize dynamically based on terminal dimensions and user preferences.
- **Graceful degradation:** Core functionality remains accessible even if advanced features unavailable.

### 4.2 Framework Selection
The TUI is built using **Textual** framework for the following reasons:

**Advantages:**
- Modern Python TUI framework with high-level layout primitives
- Native asyncio integration compatible with debugger event bus
- Excellent Windows/PowerShell support (ANSI escape sequences)
- Built-in widget system (containers, tables, text areas, etc.)
- Automatic layout management and responsive resizing
- Active development and comprehensive documentation

**Alternatives Considered:**
- `prompt_toolkit`: Excellent for CLI REPL but limited multi-pane dashboard support
- `urwid`: Lacks native Windows support and complicates asyncio integration
- `curses`: Poor Windows support and requires extensive layout scaffolding

**Dependencies:**
- `textual >= 0.58.0` (verified stable release)
- `rich >= 13.0.0` (rendering engine used by Textual)

### 4.3 Component Architecture

#### 4.3.1 Application Shell
- Main application class managing layout, event routing, and lifecycle
- Connection manager for debugger core session
- Global keyboard handler for shortcuts
- Theme and style management

#### 4.3.2 Panel Components
Each panel is a Textual widget subscribing to relevant events:

- **Registers Panel:** Display R0-R15, PC, SP, PSW with change highlighting
- **Disassembly Panel:** Show instructions around PC with symbols and breakpoint markers
- **Trace Panel:** Scrollable execution history with PC, opcode, and flags
- **Stack Panel:** Call stack with frame pointers and symbol names
- **Memory Inspector:** Hex dump with ASCII preview and editable cells
- **Watch List:** Variables and expressions with value tracking
- **Mailbox Panel:** Descriptor activity and recent messages
- **Console Panel:** Stdout/stderr output and command input
- **Status Bar:** Connection info, PID, state, and runtime counters

#### 4.3.3 Event Handlers
- Subscribe to debugger core event bus for each event category
- Transform events into panel update messages
- Throttle high-frequency updates to maintain UI responsiveness

## 5. Layout Design

### 5.1 Default Layout
```
┌─────────────────────────┬──────────────────────────────────────┬───────────────────────────────┐
│ Registers (PID 2)       │ Execution Trace                     │ Disassembly                   │
│─────────────────────────│──────────────────────────────────────│───────────────────────────────│
│ PC : 0x09F8             │ ▶ 0x09F8: ST  R7 + -4 ← R2           │ 0x09F8: ST   MEM[R7 + -4] <- R2│
│ SP : 0x7FF0             │   0x09FC: ST  R7 + -16 ← R1          │ 0x09FC: ST   MEM[R7 + -16] <- R1│
│ R0 : 0x00000000         │   0x0A00: LD  R9 ← MEM[R7 + -4]      │ 0x0A00: LD   R9, [R7 + -4]      │
│ R1 : 0x000040EF         │   0x0A04: ST  R7 + -20 ← R9          │ 0x0A04: ST   MEM[R7 + -20] <- R9│
│ R2 : 0x00000005         │   0x0A08: JMP 0x0A10                 │ 0x0A08: JMP  0x0A10            │
│ R3 : 0x00000000         │   0x0A10: LD  R4 ← MEM[R7 + -20]     │ 0x0A10: LD   R4, [R7 + -20]     │
│ ...                     │                                      │ 0x0A14: CMP  R4, R0             │
│                         │                                      │ ...                            │
├─────────────────────────┴──────────────────────────────────────┴───────────────────────────────┤
│ Tabs: [Mailboxes] [dmesg] [stdio] [scheduler] [breakpoints] [watch] [memory]                   │
│────────────────────────────────────────────────────────────────────────────────────────────────│
│ ┌ Mailboxes ────────────────────────────────────────────────────────────────────────────────┐ │
│ │ svc:stdio.in@2   depth=4   bytes=128/1024                                                │ │
│ │ app:procon       depth=1   bytes=32/512                                                  │ │
│ │ shared:hsx.msg   depth=3   bytes=96/2048                                                 │ │
│ └──────────────────────────────────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────────────────────────────────────┤
│ [Alt+S] Step   [Alt+R] Run   [Alt+B] Breakpoints   [Alt+C] Continue   [Alt+Q] Quit            │
│ [Alt+W] Watch  [Alt+T] Trace [Alt+D] Disasm        [Alt+M] Memory     [Alt+H] Help            │
│────────────────────────────────────────────────────────────────────────────────────────────────│
│ Status: RUNNING | PID=2 | Step=1095 | Program: examples/demos/build/mailbox/producer.hxe      │
└────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Compact Mode (Collapsed Auxiliary Panel)
```
┌───────────────┬──────────────────────────────────────────────────────────────┐
│ Registers     │ Execution Trace / Disassembly (linked view)                  │
│───────────────│──────────────────────────────────────────────────────────────│
│ PC : 0x09F8   │ ▶ 0x09F8: ST   MEM[R7 + -4] <- R2                            │
│ SP : 0x7FF0   │    0x09FC: ST   MEM[R7 + -16] <- R1                          │
│ R0 : 0x00000000│   0x0A00: LD   R9, [R7 + -4]                                │
│ ...           │    0x0A08: JMP  0x0A10                                       │
│───────────────┴──────────────────────────────────────────────────────────────│
│ Aux: [Mailboxes] [dmesg] [stdio] [scheduler] [breakpoints] (press Tab)      │
│ Status: RUNNING | PID=2 | Step=1095                                         │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 Stack View (Alternative to Registers)
```
┌─────────────────────────┬──────────────────────────────────────┬───────────────────────────────┐
│ Call Stack (PID 2)      │ Execution Trace                     │ Disassembly                   │
│─────────────────────────│──────────────────────────────────────│───────────────────────────────│
│ ▶ #0 mailbox_send()     │ ▶ 0x09F8: ST  R7 + -4 ← R2           │ 0x09F8: ST   MEM[R7 + -4] <- R2│
│   PC: 0x09F8            │   0x09FC: ST  R7 + -16 ← R1          │ 0x09FC: ST   MEM[R7 + -16] <- R1│
│   SP: 0x7FF0            │   0x0A00: LD  R9 ← MEM[R7 + -4]      │ 0x0A00: LD   R9, [R7 + -4]      │
│   FP: 0x7FFC            │                                      │                               │
│   #1 main()             │                                      │                               │
│   PC: 0x0E00            │                                      │                               │
│   SP: 0x8000            │                                      │                               │
│   FP: 0x800C            │                                      │                               │
│   #2 _start()           │                                      │                               │
│   PC: 0x0800            │                                      │                               │
│   SP: 0x8020            │                                      │                               │
└─────────────────────────┴──────────────────────────────────────┴───────────────────────────────┘
```

### 5.4 Memory Inspector Tab
```
┌──────────────────────────────────────────────────────────────────────────────┐
│ Memory Inspector (Alt+M)                                                     │
│──────────────────────────────────────────────────────────────────────────────│
│ Address: 0x7FF0  [Stack]   Goto: [________]  [Jump]                          │
│                                                                              │
│  Offset   +0 +1 +2 +3 +4 +5 +6 +7 +8 +9 +A +B +C +D +E +F   ASCII           │
│  ──────────────────────────────────────────────────────────────────────────  │
│  0x7FF0   00 7F 00 00 04 00 00 00 10 0A 00 00 1C 0A 00 00   ................│
│  0x8000   00 00 00 00 00 00 00 00 EF 40 00 00 05 00 00 00   .........@......│
│  0x8010   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................│
│  0x8020   A1 B2 00 00 03 00 00 00 00 00 00 00 00 00 00 00   ................│
│                                                                              │
│ [Alt+E] Edit  [Alt+G] Goto  [PgUp/PgDn] Scroll  [Home/End] Jump             │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 5.5 Breakpoint Manager Tab
```
┌──────────────────────────────────────────────────────────────────────────────┐
│ Breakpoint Manager (Alt+B)                                                  │
│──────────────────────────────────────────────────────────────────────────────│
│ Functions:                                                                  │
│   main()                         [    ]                                     │
│   ├── init_system()              [ X ]  0x0204                              │
│   ├── mailbox_send()             [    ]  0x030C                              │
│   ├── scheduler_tick()           [ X ]  0x0428                              │
│   └── uart_isr()                 [    ]  0x0572                              │
│                                                                              │
│ Disassembly (scrollable):                                                    │
│  0x0424: LD   R0, [R7 + -4]                                                 │
│▶ 0x0428: CALL 0x055A          ← Breakpoint (scheduler_tick)                 │
│  0x042C: ST   MEM[R7 + -4] <- R2                                            │
│                                                                              │
│ [Space] Toggle  [Alt+A] Add  [Del] Remove  [Enter] Jump to breakpoint       │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 5.6 Watch List Tab
```
┌──────────────────────────────────────────────────────────────────────────────┐
│ Watch List (Alt+W)                                                           │
│──────────────────────────────────────────────────────────────────────────────│
│ ID  Symbol            Value        Addr      Type      Notes                │
│ ────────────────────────────────────────────────────────────────────────────│
│ 1   counter          0x00000005   0x2000    uint32    Changed              │
│ 2   queue.depth      0x00000003   0x2010    uint16                         │
│ 3   dm.state         0x00000001   0x2020    enum      (ACTIVE)             │
│ 4   crc_acc          0x0000A1B2   0x2030    uint32                         │
│                                                                              │
│ Add: [________________]  [Enter to add]                                      │
│                                                                              │
│ [Alt+A] Add watch  [Alt+E] Edit  [Del] Remove  [Enter] Jump to address      │
└──────────────────────────────────────────────────────────────────────────────┘
```

## 6. Panel Specifications

### 6.1 Registers Panel

#### 6.1.1 Display Format
```
Registers (PID 2)
─────────────────
PC : 0x09F8
SP : 0x7FF0
PSW: [Z---]
R0 : 0x00000000
R1 : 0x000040EF  ◄ changed
R2 : 0x00000005
R3 : 0x00000000
...
R15: 0x00000000
```

#### 6.1.2 Features
- Highlight changed registers with marker (◄) and color
- Show PC with symbol name if available: `PC : 0x09F8 (main.loop)`
- Display PSW flags as `[ZCNV]` with active flags highlighted
- Toggle between decimal and hexadecimal display (Alt+X)
- Inline editing: press Enter on register to edit value

#### 6.1.3 Events
- Subscribe to `trace_step` events for register updates
- Subscribe to `debug_break` events for breakpoint hits

### 6.2 Disassembly Panel

#### 6.2.1 Display Format
```
Disassembly
───────────────────────────────
0x09F0: PUSH R7
0x09F4: MOV  R7, R6
▶ 0x09F8: ST   MEM[R7 + -4] <- R2
● 0x09FC: ST   MEM[R7 + -16] <- R1
  0x0A00: LD   R9, [R7 + -4]
  0x0A04: ST   MEM[R7 + -20] <- R9
  0x0A08: JMP  0x0A10
  0x0A0C: NOP
▶ 0x0A10: LD   R4, [R7 + -20]
  0x0A14: CMP  R4, R0
```

#### 6.2.2 Features
- Current PC marked with `▶` indicator
- Breakpoints marked with `●` indicator
- Symbol names shown as comments when available
- Scroll with Up/Down/PgUp/PgDn
- Jump to address (Alt+G)
- Set/clear breakpoint at cursor (Space or B)
- Follow jumps/calls (Enter on CALL/JMP instruction)

#### 6.2.3 Events
- Subscribe to `trace_step` events to update PC position
- Subscribe to `debug_break` events for breakpoint hits

### 6.3 Trace Panel

#### 6.3.1 Display Format
```
Execution Trace
────────────────────────────────
Seq    PC      Opcode  Instruction         Flags
──────────────────────────────────────────────────
1093   0x09F0  0x4007  PUSH R7             ----
1094   0x09F4  0x0476  MOV  R7, R6         ----
▶ 1095 0x09F8  0x0372  ST   R7-4 ← R2      ----
1096   0x09FC  0x0371  ST   R7-16 ← R1     ----
1097   0x0A00  0x0297  LD   R9 ← [R7-4]    ----
```

#### 6.3.2 Features
- Scrollable history buffer (configurable size, default 1000 entries)
- Current instruction highlighted with `▶`
- Clicking trace entry updates disassembly and register views
- Auto-scroll option to follow execution (toggle with F)
- Filter by instruction type (loads, stores, jumps, etc.)
- Export to file (Ctrl+E)

#### 6.3.3 Events
- Subscribe to `trace_step` events to append history
- Buffer management: drop oldest when capacity reached

### 6.4 Stack Panel

#### 6.4.1 Display Format
```
Call Stack (PID 2)
──────────────────
▶ #0 mailbox_send()
  PC: 0x09F8
  SP: 0x7FF0
  FP: 0x7FFC
  
  #1 main()
  PC: 0x0E00
  SP: 0x8000
  FP: 0x800C
  
  #2 _start()
  PC: 0x0800
  SP: 0x8020
  FP: 0x802C
```

#### 6.4.2 Features
- Current frame highlighted with `▶`
- Navigate frames with Up/Down
- Selecting frame updates register and disassembly views
- Show local variables when metadata available (Alt+L)
- Copy frame info to clipboard (Ctrl+C)

#### 6.4.3 Events
- Subscribe to `trace_step` events to update stack
- Subscribe to `debug_break` events after breakpoint hits

### 6.5 Memory Inspector Panel

#### 6.5.1 Features
- Hexadecimal and ASCII display
- Navigate with cursor keys and PgUp/PgDn
- Jump to address (Alt+G)
- Follow pointers (Enter on address value)
- Edit mode for memory writes (Alt+E, requires confirmation)
- Bookmark addresses (Ctrl+B)
- Show annotations for known symbols

#### 6.5.2 Events
- Manual refresh (does not auto-update)
- Refresh on request (R key)

### 6.6 Watch List Panel

#### 6.6.1 Features
- Add watches by symbol name or address expression
- Show current value, address, and type
- Highlight changed values
- Edit watch expression (Alt+E)
- Remove watch (Del key)
- Jump to address (Enter)

#### 6.6.2 Events
- Subscribe to `watch_update` events for value changes
- Refresh all watches after `trace_step` events

### 6.7 Auxiliary Panels

#### 6.7.1 Mailbox Panel
```
Mailboxes
─────────────────────────────────────────
Descriptor           Depth  Used   Capacity
svc:stdio.in@2       4      128    1024
app:procon           1      32     512
shared:hsx.msg       3      96     2048
```

Features:
- Subscribe to `mailbox_send` and `mailbox_recv` events
- Show recent messages (expandable view)
- Monitor queue depth and capacity

#### 6.7.2 Console Panel (stdio)
```
Console (stdio)
─────────────────────────────────────────
[2025-10-30 12:34:56] Starting producer...
[2025-10-30 12:34:57] Sending message 1
[2025-10-30 12:34:58] Message acknowledged
[2025-10-30 12:34:59] Sending message 2
```

Features:
- Subscribe to `stdout` and `stderr` events
- Auto-scroll to bottom
- Filter by stream (stdout/stderr)
- Search history (Ctrl+F)

#### 6.7.3 Scheduler Panel
```
Scheduler Statistics
─────────────────────────────────────────
PID  App           State     Steps    %CPU
2    producer      RUNNING   1095     52%
3    consumer      READY     1048     48%
```

Features:
- Subscribe to `scheduler` events
- Show task states and transitions
- Display CPU utilization per task

## 7. Keyboard Shortcuts

### 7.1 Global Shortcuts
| Shortcut | Action |
|----------|--------|
| Alt+S | Step (single instruction) |
| Alt+R | Run (continue execution) |
| Alt+P | Pause execution |
| Alt+C | Continue to next breakpoint |
| Alt+B | Show breakpoint manager |
| Alt+W | Show watch list |
| Alt+M | Show memory inspector |
| Alt+T | Focus trace panel |
| Alt+D | Focus disassembly panel |
| Alt+H | Show help |
| Alt+Q | Quit |
| F1 | Help |
| Tab | Switch between tabs |
| Ctrl+L | Refresh display |

### 7.2 Panel-Specific Shortcuts
| Shortcut | Panel | Action |
|----------|-------|--------|
| Enter | Registers | Edit register value |
| Alt+X | Registers | Toggle hex/decimal display |
| Space | Disassembly | Toggle breakpoint at cursor |
| Alt+G | Disassembly/Memory | Jump to address |
| Enter | Disassembly | Follow jump/call |
| F | Trace | Toggle auto-follow |
| Ctrl+E | Trace | Export to file |
| Up/Down | Stack | Navigate frames |
| Alt+L | Stack | Show local variables |
| Alt+E | Memory | Edit mode |
| Ctrl+B | Memory | Bookmark address |
| Del | Watch/Breakpoints | Remove item |

## 8. Event Handling and Updates

### 8.1 Event Subscription
The TUI subscribes to all event categories and routes them to relevant panels:

```python
event_subscriptions = {
    "trace_step": [registers_panel, disassembly_panel, trace_panel],
    "debug_break": [registers_panel, disassembly_panel, stack_panel, status_bar],
    "scheduler": [scheduler_panel, status_bar],
    "mailbox_send": [mailbox_panel],
    "mailbox_recv": [mailbox_panel],
    "watch_update": [watch_panel],
    "stdout": [console_panel],
    "stderr": [console_panel],
    "warning": [status_bar],
}
```

### 8.2 Update Throttling
To maintain UI responsiveness under high event rates:
- Batch events received within 50ms window
- Update UI at maximum 20 FPS (50ms intervals)
- Drop intermediate states for transient values
- Maintain event sequence numbers for gap detection

### 8.3 Refresh Clock
Internal timer (250ms) triggers periodic updates for:
- Connection status check
- Session keepalive
- Panel refresh requests
- Status bar updates

## 9. Responsive Layout

### 9.1 Minimum Dimensions
- Minimum terminal size: 80x24 characters
- Recommended size: 120x40 characters
- Optimal size: 160x50+ characters

### 9.2 Layout Adaptation
- **< 80 cols:** Switch to vertical stacking, hide auxiliary panels
- **80-120 cols:** Default three-column layout
- **> 120 cols:** Expand panels horizontally, show more content
- **< 24 rows:** Collapse status bar, reduce panel padding
- **> 40 rows:** Expand trace history, show more disassembly

### 9.3 Dynamic Sizing
- Registers panel: Fixed width (25 chars) or hidden
- Disassembly panel: Flexible width (30-50% of screen)
- Trace panel: Flexible width (30-50% of screen)
- Auxiliary panel: Full width or collapsible
- Status bar: Fixed height (1-2 rows)

## 10. Error Handling

### 10.1 Connection Errors
- Show connection status in status bar
- Retry connection with exponential backoff
- Cache current state for reconnection
- Display warning overlay if disconnected

### 10.2 Protocol Errors
- Log errors to internal buffer
- Show error notification in status bar
- Graceful degradation for unsupported features
- Fallback to polling if events unavailable

### 10.3 UI Errors
- Catch and log rendering exceptions
- Maintain UI responsiveness during errors
- Provide error details in help/debug view
- Allow user to report issues (Ctrl+R)

## 11. Testing Strategy

### 11.1 Unit Tests
- Panel rendering with mock data
- Event routing and filtering
- Keyboard shortcut handling
- Layout calculations for different terminal sizes

### 11.2 Integration Tests
- Full TUI with simulated executive
- Event streaming under load
- Breakpoint workflows
- Multi-panel interactions

### 11.3 Manual Testing
- Cross-platform validation (Windows/macOS/Linux)
- Terminal compatibility (PowerShell, Terminal, tmux)
- Keyboard navigation workflows
- Resize and refresh behavior

### 11.4 Performance Testing
- Event processing latency
- UI update rate under high load
- Memory usage over extended sessions
- Reconnection after network interruption

## 12. Documentation Requirements

### 12.1 User Documentation
- Quick-start guide with screenshots
- Panel descriptions and features
- Keyboard shortcut reference
- Common workflows and examples

### 12.2 Developer Documentation
- Panel implementation guide
- Event handler customization
- Theme and style customization
- Extension points for custom panels

## 13. TUI Mockups

### 13.1 Default Layout (Text Mockup)
```
┌─────────────────────────┬──────────────────────────────────────┬───────────────────────────────┐
│ Registers (PID 2)       │ Execution Trace                     │ Disassembly                   │
│─────────────────────────│──────────────────────────────────────│───────────────────────────────│
│ PC : 0x09F8             │ ▶ 0x09F8: ST  R7 + -4 ← R2           │ 0x09F8: ST   MEM[R7 + -4] <- R2│
│ SP : 0x7FF0             │   0x09FC: ST  R7 + -16 ← R1          │ 0x09FC: ST   MEM[R7 + -16] <- R1│
│ R0 : 0x00000000         │   0x0A00: LD  R9 ← MEM[R7 + -4]      │ 0x0A00: LD   R9, [R7 + -4]      │
│ R1 : 0x000040EF         │   0x0A04: ST  R7 + -20 ← R9          │ 0x0A04: ST   MEM[R7 + -20] <- R9│
│ R2 : 0x00000005         │   0x0A08: JMP 0x0A10                 │ 0x0A08: JMP  0x0A10            │
│ ...                     │   0x0A10: LD  R4 ← MEM[R7 + -20]     │ 0x0A10: LD   R4, [R7 + -20]     │
│                         │                                      │ 0x0A14: CMP  R4, R0             │
│                         │                                      │ ...                            │
├─────────────────────────┴──────────────────────────────────────┴───────────────────────────────┤
│ Tabs: [Mailboxes] [dmesg] [stdio] [scheduler] [breakpoints]                                     │
│────────────────────────────────────────────────────────────────┬────────────────────────────────│
│ ┌ Mailboxes ──────────────────────────────────┐ │ [Alt+S] Step   [Alt+R] Run   [Alt+B] Breakpoints  │
│ │ svc:stdio.in@2   depth=4                │ │ [Alt+C] Continue   [Alt+Q] Quit   [Alt+M] Memory  │
│ │ app:procon       depth=1                │ │ [Alt+W] Watch vars [Alt+T] Trace   [Alt+D] Disasm │
│ │ shared:hsx.msg   depth=3                │ │──────────────────────────────────────────────────│
│ └─────────────────────────────────────────┘ │ Status: RUNNING | PID=2 | Step=1095 | Program:    │
│                                             │ examples/demos/build/mailbox/producer.hxe        │
└────────────────────────────────────────────┴────────────────────────────────────────────────────┘
```

### 13.2 Breakpoint Handling Concepts
- **Virtual breakpoints (default):** Run VM in auto single-step mode and evaluate PC after each instruction; pause when it matches an enabled breakpoint.
- **BRK instruction support:** When BRK opcodes fire (BP_TRAP), debugger enters break mode; coexists with virtual breakpoints.
- **Data model:**
  ```c
  struct Breakpoint {
      uint16_t addr;
      bool     enabled;
      bool     hit;
      char     symbol[32];
  };
  ```

### 13.3 Keyboard Shortcuts Brainstorm
| Function       | Shortcut |
|----------------|----------|
| Step           | Alt+S    |
| Run            | Alt+R    |
| Continue       | Alt+C    |
| Breakpoints    | Alt+B    |
| Watch vars     | Alt+W    |
| Trace toggle   | Alt+T    |
| Disassembly    | Alt+D    |
| Memory view    | Alt+M    |
| Quit           | Alt+Q    |
| Switch tabs    | ← / → or Alt+1–5 |

Tabs can also be toggled programmatically; highlight indicates active pane.

### 13.4 Design Notes
- Tabbed auxiliary panel keeps the layout clean while enabling varied telemetry (mailboxes/dmesg/stdio/scheduler/breakpoints).
- Consistent shortcut legend aids discoverability across pages.
- Automatic single-step execution simplifies breakpoint detection and ensures deterministic behaviour.
- Status bar aggregates mode, PID, runtime counters, and program metadata (pretty output from `ps <pid>`).
- Event flow combines executive-published mailbox notifications with the internal refresh clock so the UI reacts promptly without heavy polling.

## 14. Configurable Window Layouts

### 14.1 Layout Configuration System
The TUI supports user-configurable panel layouts through YAML/JSON configuration files, enabling customization of panel positions, sizes, and behavior without code modification.

**Configuration File Location:** `~/.hsxdbg/layout.yaml` or `${WORKSPACE}/.hsxdbg/layout.yaml`

**Configuration Structure:**
```yaml
version: 1
default_layout: "debug_full"

layouts:
  debug_full:
    name: "Full Debug Layout"
    description: "Comprehensive debugging with all panels visible"
    panels:
      - type: "source"
        position: {row: 0, col: 0, width: 40, height: 25}
        config:
          show_line_numbers: true
          syntax_highlighting: true
          highlight_current_line: true
          show_breakpoint_gutter: true
      
      - type: "registers"
        position: {row: 0, col: 40, width: 20, height: 12}
        config:
          format: "hex"  # or "decimal", "binary"
          show_flags: true
          highlight_changed: true
      
      - type: "disassembly"
        position: {row: 0, col: 60, width: 40, height: 25}
        config:
          show_symbols: true
          show_addresses: true
          show_opcodes: false
          context_lines: 10
      
      - type: "trace"
        position: {row: 12, col: 40, width: 20, height: 13}
        config:
          max_entries: 100
          auto_scroll: true
      
      - type: "stack"
        position: {row: 25, col: 0, width: 50, height: 10}
        config:
          max_depth: 20
          show_frame_args: true
      
      - type: "watch"
        position: {row: 25, col: 50, width: 50, height: 10}
        config:
          auto_evaluate: true
      
      - type: "console"
        position: {row: 35, col: 0, width: 100, height: 10}
        config:
          buffer_lines: 1000
    
    status_bar:
      enabled: true
      position: "bottom"
      show_connection: true
      show_pid: true
      show_counters: true
  
  compact:
    name: "Compact Layout"
    description: "Minimal layout for small terminals"
    panels:
      - type: "source"
        position: {row: 0, col: 0, width: 60, height: 30}
      
      - type: "registers"
        position: {row: 0, col: 60, width: 40, height: 15}
      
      - type: "console"
        position: {row: 15, col: 60, width: 40, height: 15}
    
    status_bar:
      enabled: true
      position: "bottom"

keybindings:
  global:
    "F5": "continue"
    "F10": "step_source"
    "F11": "step_instruction"
    "Shift+F11": "step_out"
    "F9": "toggle_breakpoint"
    "Ctrl+Shift+F5": "restart"
    "Shift+F5": "stop"
    "Alt+1": "switch_layout:debug_full"
    "Alt+2": "switch_layout:compact"
  
  source_panel:
    "g": "goto_line"
    "/": "search"
    "n": "next_match"
    "N": "prev_match"
  
  disassembly_panel:
    "g": "goto_address"
    "Space": "toggle_breakpoint"
    "Enter": "follow_jump"

theme:
  name: "monokai"
  colors:
    current_line: "#3E3D32"
    breakpoint: "#F92672"
    highlight: "#FD971F"
    changed_register: "#A6E22E"
    pc_indicator: "#66D9EF"
```

### 14.2 Panel Types and Configuration

#### 14.2.1 Source Panel
Displays C/C++ source code with syntax highlighting and debugging annotations.

**Configuration Options:**
- `show_line_numbers`: Display line numbers (default: true)
- `syntax_highlighting`: Enable syntax coloring (default: true)
- `highlight_current_line`: Highlight line at current PC (default: true)
- `show_breakpoint_gutter`: Show breakpoint markers in gutter (default: true)
- `tab_width`: Tab size in spaces (default: 4)
- `wrap_lines`: Enable line wrapping (default: false)

**Features:**
- Syntax highlighting using `rich` library
- Current execution line highlighted
- Breakpoint indicators in gutter
- Jump to definition (if symbols available)
- Search within file

#### 14.2.2 Registers Panel
Displays CPU registers with real-time updates and change highlighting.

**Configuration Options:**
- `format`: Display format - "hex", "decimal", "binary" (default: "hex")
- `show_flags`: Display PSW flags expanded (default: true)
- `highlight_changed`: Highlight registers that changed in last step (default: true)
- `group_by`: Group registers - "none", "type", "usage" (default: "none")

**Features:**
- Real-time update on trace_step events
- Change indicators (◄ marker and color)
- Click to edit (if supported)
- Copy register value to clipboard

#### 14.2.3 Disassembly Panel
Shows disassembled instructions with symbols and breakpoint markers.

**Configuration Options:**
- `show_symbols`: Display function/label symbols (default: true)
- `show_addresses`: Display instruction addresses (default: true)
- `show_opcodes`: Display raw opcode bytes (default: false)
- `context_lines`: Number of instructions to show around PC (default: 10)
- `auto_center`: Auto-scroll to keep PC centered (default: true)

**Features:**
- Current instruction indicated with ▶
- Breakpoints indicated with ●
- Symbol annotations
- Follow jumps/calls with Enter
- Set breakpoints with Space

#### 14.2.4 Stack Panel
Displays call stack with frame information.

**Configuration Options:**
- `max_depth`: Maximum number of frames to display (default: 20)
- `show_frame_args`: Show function arguments if available (default: true)
- `show_locals`: Show local variables in frame (default: false)

#### 14.2.5 Watch Panel
Monitors variables and expressions.

**Configuration Options:**
- `auto_evaluate`: Automatically re-evaluate on each step (default: true)
- `format`: Default format for values (default: "auto")

### 14.3 Runtime Layout Management

**Layout Switching:**
- Use Alt+1, Alt+2, etc. to switch between predefined layouts
- Smooth transitions without losing panel state
- Layout persists across sessions

**Dynamic Resizing:**
- Panels automatically resize based on terminal dimensions
- Minimum viable sizes enforced (e.g., source panel minimum 40x20)
- Panels hide gracefully if terminal too small

**Custom Layout Creation:**
- Save current panel arrangement: `:layout save my_layout`
- Edit configuration file directly
- Reload configuration: `:layout reload`

### 14.4 Implementation

**Layout Manager Class:**
```python
class LayoutManager:
    def __init__(self, config_path: str):
        self.config = self.load_config(config_path)
        self.current_layout = None
        self.panels = {}
    
    def apply_layout(self, layout_name: str):
        """Apply specified layout configuration"""
        layout = self.config['layouts'][layout_name]
        
        # Remove existing panels
        for panel in self.panels.values():
            panel.remove()
        self.panels.clear()
        
        # Create new panels based on configuration
        for panel_spec in layout['panels']:
            panel = self.create_panel(panel_spec)
            self.panels[panel_spec['type']] = panel
        
        self.current_layout = layout_name
    
    def create_panel(self, spec: Dict) -> Widget:
        """Factory method to create panel from specification"""
        panel_type = spec['type']
        pos = spec['position']
        config = spec.get('config', {})
        
        if panel_type == 'source':
            return SourcePanel(pos, config)
        elif panel_type == 'registers':
            return RegistersPanel(pos, config)
        # ... other panel types
```

## 15. Source File Display

### 15.1 Source Panel Integration
The TUI includes a source file viewer panel that displays the original C/C++ source code alongside disassembly, enabling source-level debugging.

**Features:**
- Syntax highlighting with language detection
- Current execution line highlighted
- Breakpoint markers in gutter
- Line number display
- Search within file
- Jump to definition

**Source File Loading:**
1. PC obtained from trace_step event or register query
2. PC mapped to (file, line) using .sym file
3. Source file loaded from filesystem using path resolution
4. File cached for performance
5. Current line highlighted in display

**Path Resolution Algorithm:**
1. Try exact path from .sym file (if absolute and exists)
2. Try relative to .sym file location
3. Try relative to project root (from config or sources.json)
4. Try configured source search paths
5. Prompt user for location if not found

### 15.2 Source-Level Stepping

**Step Source (F10 / Alt+S):**
- Issue step commands until PC crosses source line boundary
- Query .sym for source line after each instruction step
- Stop when line number changes
- More intuitive for high-level debugging

**Step Instruction (F11 / Alt+I):**
- Single instruction step
- Useful for examining compiler output
- Shows exact instruction execution

**Implementation:**
```python
async def step_source(self):
    """Step to next source line"""
    current_pc = await self.get_register('PC')
    current_line = self.symbol_loader.resolve_pc(current_pc)['line']
    
    # Step until line changes (with safety limit)
    for _ in range(1000):
        await self.executive.step(1)
        new_pc = await self.get_register('PC')
        new_line = self.symbol_loader.resolve_pc(new_pc)['line']
        
        if new_line != current_line:
            break
    
    await self.update_panels()
```

### 15.3 Source Path Configuration

**Configuration File:** `~/.hsxdbg/sources.yaml`

```yaml
project_root: "/home/user/hsx-project"
source_paths:
  - "${project_root}/src"
  - "${project_root}/include"
  - "/usr/local/include/hsx"

# Path remapping for relocated sources
source_map:
  "/old/build/path": "${project_root}"
  "/ci/build": "${project_root}"

# Auto-generated by build system
sources_json: "${project_root}/build/debug/sources.json"
```

**Build System Integration:**
The build system generates `sources.json` mapping relative paths to absolute paths:

```json
{
  "version": 1,
  "project_root": "/home/user/hsx-project",
  "sources": [
    {
      "file": "main.c",
      "path": "/home/user/hsx-project/main.c",
      "relative": "./main.c"
    },
    {
      "file": "src/utils.c",
      "path": "/home/user/hsx-project/src/utils.c",
      "relative": "./src/utils.c"
    }
  ]
}
```

### 15.4 Syntax Highlighting

Using `rich` library (already a Textual dependency):

```python
from rich.syntax import Syntax

def render_source(file_path: str, current_line: int):
    """Render source with syntax highlighting"""
    with open(file_path) as f:
        code = f.read()
    
    # Detect language from extension
    if file_path.endswith('.c'):
        lexer = 'c'
    elif file_path.endswith('.cpp'):
        lexer = 'cpp'
    else:
        lexer = 'text'
    
    syntax = Syntax(
        code,
        lexer,
        theme="monokai",
        line_numbers=True,
        highlight_lines={current_line}
    )
    return syntax
```

## 16. Library Dependencies

### 16.1 Core Dependencies

**Textual (>= 0.58.0):**
- Primary TUI framework
- Provides widget system, layout management, event handling
- Excellent cross-platform support (Windows/Linux/macOS)
- Native asyncio integration
- License: MIT
- Installation: `pip install textual`

**Rich (>= 13.0.0):**
- Rendering engine for Textual
- Syntax highlighting capabilities
- Table and tree rendering
- Color and styling support
- License: MIT
- Installation: `pip install rich` (installed with Textual)

### 16.2 Optional Dependencies

**Pygments (>= 2.14.0):**
- Advanced syntax highlighting
- Used by Rich for lexer support
- Hundreds of language lexers
- License: BSD
- Installation: `pip install pygments`

**watchdog (>= 3.0.0):**
- File system monitoring
- Auto-reload sources.json on change
- License: Apache 2.0
- Installation: `pip install watchdog`

### 16.3 Development Dependencies

**pytest (>= 7.0.0):**
- Unit testing framework
- Installation: `pip install pytest`

**pytest-asyncio (>= 0.21.0):**
- Async test support
- Installation: `pip install pytest-asyncio`

**black (>= 23.0.0):**
- Code formatting
- Installation: `pip install black`

**mypy (>= 1.0.0):**
- Type checking
- Installation: `pip install mypy`

### 16.4 Requirements File

**requirements.txt:**
```
textual>=0.58.0
rich>=13.0.0
pygments>=2.14.0
watchdog>=3.0.0
```

**requirements-dev.txt:**
```
-r requirements.txt
pytest>=7.0.0
pytest-asyncio>=0.21.0
black>=23.0.0
mypy>=1.0.0
```

## 14. Traceability
- **Design Requirements:** DR-1.3, DR-3.1, DR-8.1.
- **Design Goals:** DG-1.4, DG-8.1, DG-8.2, DG-8.3.
- **Design Options:** DO-relay (future remote debugging), DO-8.a (advanced TUI features).
