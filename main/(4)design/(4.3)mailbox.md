# Design Spec — Mailbox Subsystem

## Scope
- Kernel-owned mailbox service providing task-to-task and host IPC.
- Support namespaces (`svc`, `app`, `shared`) with configurable delivery modes (single-reader, all-readers, taps).
- Provide stdio streams, telemetry fan-out, and shell/debugger integrations.

## Data Structures
- **Descriptor:** capacity, payload length, flags (`BLOCK`, `FANOUT`, `TAP`), owner PID / namespace tag, pending message count, wait queue.
- **Handle table:** per-task array mapping handle id → descriptor pointer + access mode; includes refcounts for shared descriptors.
- **Message frame:** 16-bit length, 16-bit flags, 16-bit src_pid, 16-bit channel, followed by payload bytes (payload <= capacity - header size).
- **Wait queues:** singly-linked lists per descriptor to track blocked receivers/senders (with timeout metadata).

## Algorithms / Behaviour
- **Bind/Open:** resolve namespace string; for `svc:` create per-task descriptors (stdio, control); for `app:` share global descriptor; for `shared:` create shared descriptor with fan-out policy.
- **Send:** copy payload, enforce capacity, wake one waiter (or all for fan-out); handle non-blocking/back-pressure; log event for tracing.
- **Recv:** if queue empty, block task (WAIT_MBX) with timeout; on message arrival, deliver header/payload, update statistics.
- **Tap:** maintain secondary consumer list; taps receive copies without consuming original message.
- **Timeouts:** decrement timer via executive; on expiry, post timeout event and return `HSX_MBX_STATUS_TIMEOUT`.

## Edge Cases
- Descriptor exhaustion: return `HSX_MBX_STATUS_NO_DESCRIPTOR`, surface trace for diagnostics.
- Handle leaks: on task exit, iterate handle table, decrement descriptor refcounts, free if zero.
- Stdio tapping: ensure stdout fan-out does not starve default reader; respect rate limits.
- Embedded profile: compile-time limits for descriptors/payload, disable `shared:` namespace to save RAM.

## Testing Considerations
- Unit tests covering bind/open combinations, blocking send/recv, timeout paths.
- Integration tests validating stdio bridging, value subscription via `val.sub`, shell `listen` command.
- Stress tests for high-frequency traffic and fan-out scenarios to verify back-pressure.
