# Design Spec — Executive

## Scope
- Host controller managing MiniVM lifecycle, scheduling, and IPC services.
- JSON-over-TCP RPC server consumed by shell/debugger/tooling.
- Event capture and fan-out (trace, breakpoints, mailbox transitions).
- Provisioning workflows (load/reload tasks, FRAM persistence) for CAN/SD/host sources.

## Data Structures
- **ExecutiveState:** task table (PID → context), run queue counters, log buffer (bounded deque), auto-clock state, session registry.
- **Session records:** track client id, attached PID, capability handshake, keepalive timers, and pending event cursors.
- **Task metadata cache:** mirrors MiniVM context plus mailbox descriptors, value snapshots, debug state (breakpoints, last stop info).
- **Provisioning state:** active image info, FRAM key/value map, pending reload targets.

## Algorithms / Behaviour
- **RPC handling:** parse command, enforce session locks, translate into MiniVM/mailbox/value operations, return status with telemetry.
- **Attach/detach:** pause MiniVM, clone context, assign session lock, resume on detach; support PID-specific attachments.
- **Scheduling:** auto-clock loop invoking `vm.step` per quantum, tracking total steps, supporting run-to-PC (temporary breakpoints) and single-task stepping.
- **Event streaming:** queue events from MiniVM/mailbox/value subsystems, support subscriber cursors, acknowledgements, and drop-oldest back-pressure with telemetry metrics.
- **Provisioning:** load `.hxe` via host path, CAN transfer, or SD manifest; verify CRC, set entry, initialise FRAM-backed values before resuming task.
- **Persistence:** on `val.persist`, bind FRAM key, load at attach, save on update or graceful shutdown.

## Edge Cases
- MiniVM disconnect/crash detection with automatic restart (if configured) and session notification.
- Concurrent clients: enforce PID locks, plan read-only observer mode without breaking shell semantics.
- Resource exhaustion: descriptor/value table saturation, FRAM key collisions, event queue overflow (throttle or drop with diagnostics).
- Clock throttling when all tasks blocked (mailbox wait) to avoid busy looping.

## Testing Considerations
- RPC integration via `python/tests/test_exec_smoke.py`, CLI smoke scripts.
- Auto-clock and run-to-PC regression cases (`python/tests/test_vm_pause.py`).
- Session lock conflict tests (simultaneous shell/debugger attaches).
- Provisioning/persistence simulations (mock CAN transfers, FRAM load/save unit tests).
