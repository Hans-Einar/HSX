# System Design — HSX Runtime Core

> Detailed design for MiniVM, executive, mailbox subsystem, and related runtime services.

## 1. MiniVM
- **Responsibilities:** Execute HSX ISA instructions; maintain per-task state (register base pointer, stack pointers, flags); operate under host control with no resident OS or shell in the VM.
- **Context switching:** Registers referenced via configurable base pointer; executive updates pointer before each step when switching tasks.
- **Debug hooks:** Emit events for breakpoints, single steps, sleep/wake conditions via `emit_event`.
- **Extensibility:** Plan for C port with consistent interfaces (e.g., RPC façade, context struct).

## 2. Executive
- **Scheduling:** Round-robin/priority scheduling across tasks; run queue managed in Python prototype with future parity in C.
- **Session management:** PID-scoped sessions, capability negotiation, heartbeat monitoring.
- **Run control:** Step, resume, run-to-PC, and breakpoint mediation; interface to MiniVM via RPC or direct calls.
- **Event stream:** Persistent stream of VM events (trace, mailbox, debug) with back-pressure and subscription controls.
- **Provisioning:** Load HSX apps from host storage, CAN/J1939 master, or on-device media (SD/FRAM) during boot/attach phases.

## 3. Mailbox Subsystem
- **Concept:** Named mailboxes with configurable delivery modes (first-reader clears, all-readers clears, taps).
- **API:** Opening/binding, send/receive, taps; support for stdio bindings, hardware HAL endpoints (GPIO/UART/CAN), and future extensions.
- **Storage:** Descriptors tracked in executive; mirror state in MiniVM/HAL where needed; enforce subscriber semantics for domain-app communication.

## 4. Persistence & Metadata
- **Symbol tables:** Provide optional symbol/line info for debugger; stored alongside tasks or via sidecar files.
- **Trace logs:** Retain bounded history accessible via executive commands/UI.

## 5. Portability Considerations
- Python implementation acts as reference; design ensures deterministic behaviour that can be ported to embedded targets (AVR/Cortex‑M).
- HAL abstractions for IO (UART/CAN/FRAM) remain stable across languages.
- Host executive in C shares the same command surface as the Python prototype so tooling can transparently attach.

## Dependencies
- Received events drive tooling; design must expose clean interfaces for `system_design` ↔ `toolkit_design`.
- Align with documentation requirements in `docs/hsx_spec-v2.md` and DoD checklists.
