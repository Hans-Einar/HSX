# Design Spec — Tooling (Shell & Debugger)

## Scope
- Provide interactive CLI for manual control, scripting, and diagnostics.
- Deliver debugger experience (CLI + TUI) via shared core (`hsxdbg`) handling sessions, breakpoints, and watch state.
- Support automation workflows (JSON output, scripting API) and packaging/release processes.

## Data Structures
- **Shell command registry:** mapping command name → handler, documentation, JSON flag.
- **Debugger session model:** connection info, attached PID, capability set, watch/breakpoint tables.
- **Event bus:** queue/type filters feeding CLI/TUI; includes back-pressure metrics and last-seen sequence numbers.
- **State cache:** per-PID snapshots (registers, stack frames, memory ranges, values) for incremental UI updates.
- **UI models:** panel descriptors for Textual layout, prompt_toolkit key bindings/history.

## Algorithms / Behaviour
- **Shell:** parse command (attach, clock, val, cmd, mbox), call executive RPC, render text/JSON. Support `ps <pid>` filter, `val get group:id` addressing, `listen` for stdio.
- **Debugger attach:** negotiate capabilities, lock PID, start event subscription, seed caches (registers, symbols, values).
- **Event processing:** fan events through bus, update caches, trigger UI refresh; handle drop-oldest by resyncing state.
- **Watch/breakpoint management:** map symbols to addresses, sync with executive (`debug_breakpoints`), update UI on change.
- **TUI loop:** Textual application scheduling updates, key bindings for stepping, breakpoints, panel focus.
- **Automation:** `hsx dbg --json` output, scripting API exposing session methods.
- **Packaging:** `make dev-env` for dependencies; `make package/release` flatten CLI + debugger entry points.

## Edge Cases
- Executive protocol mismatch: downgrade to polling or warn user; ensure backwards compatibility with legacy servers lacking event stream.
- Event back-pressure: detect queue overflow, request slow-down, resynchronise caches when gaps detected.
- Connection loss: auto-retry with exponential backoff; preserve local state for reconnection; inform user of potential stale data.
- Concurrent CLI/Debugger operations on same host; ensure shared configuration (history files, workspace paths) handled safely.

## Testing Considerations
- Unit tests for CLI parsing, JSON output formatting, event bus transformations.
- Integration tests attaching to simulated executive (`python/tests/test_host_vm_cli.py`, new debugger pipelines) covering attach-run-detach, breakpoints, value watch.
- Snapshot/visual tests for Textual panels (registers, trace, watch list) and prompt_toolkit key bindings.
- Cross-platform manual checklist (Windows PowerShell, macOS Terminal, Linux/tmux) ensuring rendering and keymaps behave.
