# Design Spec â€” Toolchain & Artefacts

## Preconditions
- Source language front-ends (clang/llc) produce LLVM IR compatible with hsx-llc.py lowering (DR-3.1, DG-3.2).
- MiniVM/Executive ISA and ABI contracts are stable (see (4.1)vm.md, (4.2)executive.md) (DR-2.2, DR-2.3, DR-2.5, DG-2.1–2.3).
- Build environment provides Python 3.11+, LLVM toolchain, and packaging dependencies (DR-1.3, DG-3.2).

## Postconditions
- Toolchain emits .hxo/.hxe artefacts with deterministic layouts, relocation info, and optional debug metadata for debugger consumption (DR-3.1, DG-3.1, DG-3.3, DG-3.5).
- Register allocation, spill handling, and instruction lowering satisfy VM constraints and pass regression suites (DR-2.1a, DR-2.2, DG-3.2).
- Build/publishing scripts assemble SDK packages, documentation, and sample artefacts aligned with HSX release process (DR-1.2, DR-2.5).

## Scope
- LLVM lowering (hsx-llc.py) and register allocation (DR-2.2, DR-2.1a, DG-3.2).
- Assembler/linker (sm.py, hld.py) and object formats (HXO/HXE) (DR-3.1, DG-3.1).
- Debug metadata generation (listings, symbol sidecars) (DR-3.1, DG-3.3, DG-3.5).
- Packaging/build scripts (DR-1.2, DR-2.5).

## Data Structures
- **LLVM lowering state:** register pool (`available_regs`, `virt_to_phys`), live interval metadata, spill stack slots.
- **MVASM instruction model:** opcode enum, operand descriptors (register, immediate, label) encoded into 16-bit primary words with extension words.
- **HXO object format:** JSON header describing sections/relocations + binary blobs. Example skeleton:
  ```json
  {
    "version": 1,
    "sections": {
      "text": "<hex>",
      "data": "<hex>"
    },
    "relocs": [ {"offset": 0x10, "type": "ABS16", "symbol": "foo"} ],
    "symbols": [ {"name": "_start", "section": "text", "value": 0} ]
  }
  ```
- **HXE executable header:** fixed layout with magic `HSXE`, version, code/ro lengths, BSS size, entry offset, required capability bits, CRC32.
- **Debug metadata:** optional listing JSON mapping PC â†’ symbol/file/line, and value/command descriptors exported by `asm.py --dump-json` for tooling.
- **Provisioning manifest (future):** TOML/JSON describing required FRAM keys, default values, mailbox names consumed by provisioning layer.

## Algorithms / Behaviour
- **IR to MVASM lowering:** `hsx-llc.py` legalises LLVM IR, lowers arithmetic/control ops, emits SVC calls with module/function IDs. Maintains ABI contract (R1-R3 for args, stack spill thereafter).
- **Register allocation:** linear-scan across basic blocks; uses caller-saved registers first, spills to stack slots (word-aligned). Future work: tune for minimal spills when workspace pointer refactor lands.
- **Assembler (`asm.py`):** parse MVASM, resolve labels, encode opcodes, build relocation table, emit `.hxo`. Provides `--listing` and `--dump-json` for debugger support.
- **Linker (`hld.py`):** merge `.hxo` files, resolve externs, allocate final addresses, generate `.hxe` header, compute CRC32. (P0) Document header fields in `docs/hxe_format.md`.
- **Manifest/persistence integration:** attach provisioning metadata (FRAM keys, values) to `.hxe`; loader uses this during provisioning.
- **Debug metadata emission:** export symbol/line info and value/command descriptors consumed by tooling; ensure compatibility between Python and future native toolchains.

## Edge Cases
- Unsupported LLVM IR constructs (diagnostics, fallbacks).
- Relocation overflow/section size limits.
- Toolchain compatibility between Python prototype and future native tools.
- `.hxe` version mismatch triggers friendly error; fallback to older loader behaviour when possible.
- CRC failure or truncated payload should abort provisioning and notify executive.
- FRAM key manifest referencing nonexistent values flagged at link time.

## Testing Considerations
- Unit tests for lowering patterns and assembler directives.
- Integration tests building sample apps end-to-end (C â†’ HXE â†’ VM).
- Validation of CRC/header integrity and symbol metadata.
- Regression tests for `.hxe` compatibility across versions.
- Verify tooling (shell/debugger) can consume emitted JSON symbol/value descriptors.

## Traceability
- **Design Requirements:** DR-1.2, DR-1.3, DR-2.1a, DR-2.2, DR-2.3, DR-2.5, DR-3.1.
- **Design Goals:** DG-1.3, DG-1.4, DG-2.1–2.3, DG-3.1–3.5.
- **Design Options:** DO-3.a, DO-hxe-sym.

