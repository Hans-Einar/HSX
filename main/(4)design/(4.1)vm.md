# Design Spec — MiniVM

## Scope
- Execute HSX ISA for a single task under executive control.
- Maintain per-task architectural state (register workspace pointer, stack pointers, flags) without an in-VM OS.
- Provide debugging hooks (breakpoints, run-to-PC, instruction trace) surfaced through the executive.

## Data Structures
- **Register workspace:** contiguous 16×32-bit registers stored in RAM; `reg_base` points to active window.
- **Task context:** struct containing `pc`, `reg_base`, `stack_base`, `sp`, `psw`, sleep state, and mailbox wait metadata.
- **Debug/event state:** per-task flags (`debug_enabled`, `breakpoints`, `single_step_remaining`) and pending event buffer consumed by executive.

## Algorithms / Behaviour
- **Fetch/decode/execute:** 16-bit opcode fetch with extension words; operations update register workspace and memory.
- **Context switching:** executive repoints `reg_base`/`stack_base` before invoking `step`; no register copying required.
- **Trap handling:** SVC captures argument registers (`R0-R3`) and posts events; BRK halts execution, records stop reason, and notifies executive.
- **Debug flow:** honour `debug_breakpoints`, `single_step_remaining`, and async break requests before executing instructions.
- **Sleep semantics:** `request_sleep` records delay; when not attached, VM waits locally; when attached, executive handles scheduling.

## Edge Cases
- Register workspace overflow/underflow when instructions compute out-of-range addresses (trap to error event).
- Mailbox wait handling when executive detached (fall back to internal scheduler loops).
- Safe behaviour when task sleeps while debug single-step active (ensure wake resumes at correct breakpoint state).

## Testing Considerations
- ISA compliance via `python/tests/test_ir2asm` and new opcode coverage tests.
- Breakpoint/run-to-PC regressions (verify `debug_stop` events, skip logic, async break).
- Standalone vs executive-attached scenarios (`python/tests/test_vm_pause`, manual smoke using `host_vm.py`).
